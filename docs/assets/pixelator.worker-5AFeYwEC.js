(function(){"use strict";function W(n){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function V(n){let t=n.r/255,o=n.g/255,s=n.b/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,t*=100,o*=100,s*=100,{x:t*.4124+o*.3576+s*.1805,y:t*.2126+o*.7152+s*.0722,z:t*.0193+o*.1192+s*.9505}}function $(n){let t=n.x/95.047,o=n.y/100,s=n.z/108.883;return t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(t-o),b:200*(o-s)}}function H(n){return $(V(n))}function T(n){let t=n.r/255,o=n.g/255,s=n.b/255;t=t>=.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>=.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>=.04045?Math.pow((s+.055)/1.055,2.4):s/12.92;const f=.4122214708*t+.5363325363*o+.0514459929*s,y=.2119034982*t+.6806995451*o+.1073969566*s,l=.0883024619*t+.2817188376*o+.6299787005*s,d=Math.cbrt(f),c=Math.cbrt(y),p=Math.cbrt(l);return{L:.2104542553*d+.793617785*c-.0040720468*p,a:1.9779984951*d-2.428592205*c+.4505937099*p,b:.0259040371*d+.7827717662*c-.808675766*p}}function B(n,t){const o=n.l-t.l,s=n.a-t.a,f=n.b-t.b;return Math.sqrt(o*o+s*s+f*f)}function N(n,t){const o=(n.r+t.r)/2,s=n.r-t.r,f=n.g-t.g,y=n.b-t.b;return Math.sqrt((2+o/256)*s*s+4*f*f+(2+(255-o)/256)*y*y)}function j(n,t){const o=n.l-t.l,s=Math.sqrt(n.a*n.a+n.b*n.b),f=Math.sqrt(t.a*t.a+t.b*t.b),y=s-f,l=n.a-t.a,d=n.b-t.b;let c=l*l+d*d-y*y;c<0&&(c=0);const p=Math.sqrt(c),m=1,r=.045,M=.015,a=1,h=1+r*s,g=1+M*s,x=o/(m*a),b=y/h,i=p/g;return Math.sqrt(x*x+b*b+i*i)}function D(n,t){const o=n.l,s=n.a,f=n.b,y=t.l,l=t.a,d=t.b,c=Math.sqrt(s*s+f*f),p=Math.sqrt(l*l+d*d),m=(c+p)/2,r=Math.pow(m,7),M=.5*(1-Math.sqrt(r/(r+6103515625))),a=s*(1+M),h=l*(1+M),g=Math.sqrt(a*a+f*f),x=Math.sqrt(h*h+d*d),b=(g+x)/2;let i=Math.atan2(f,a)*(180/Math.PI);i<0&&(i+=360);let e=Math.atan2(d,h)*(180/Math.PI);e<0&&(e+=360);let w=y-o,C=x-g,k;g*x===0?k=0:Math.abs(e-i)<=180?k=e-i:e-i>180?k=e-i-360:k=e-i+360;const R=2*Math.sqrt(g*x)*Math.sin(k*Math.PI/180/2),I=(o+y)/2;let u;g*x===0?u=i+e:Math.abs(i-e)<=180?u=(i+e)/2:i+e<360?u=(i+e+360)/2:u=(i+e-360)/2;const E=1-.17*Math.cos((u-30)*Math.PI/180)+.24*Math.cos(2*u*Math.PI/180)+.32*Math.cos((3*u+6)*Math.PI/180)-.2*Math.cos((4*u-63)*Math.PI/180),L=1+.015*(I-50)*(I-50)/Math.sqrt(20+(I-50)*(I-50)),q=1+.045*b,S=1+.015*b*E,v=Math.pow(b,7),z=-2*Math.sqrt(v/(v+6103515625))*Math.sin(60*Math.PI/180*Math.exp(-((u-275)/25)*((u-275)/25))),X=w/L,_=C/q,P=R/S;return Math.sqrt(X*X+_*_+P*P+z*_*P)}function J(n,t){const o=n.L-t.L,s=n.a-t.a,f=n.b-t.b;return Math.sqrt(o*o+s*s+f*f)*100}const K=B;function Q(n,t,o){const s=n.data,f=new ImageData(t,o),y=f.data,l=n.width/t,d=n.height/o;for(let c=0;c<o;c++)for(let p=0;p<t;p++){const m=Math.floor(p*l),M=(Math.floor(c*d)*n.width+m)*4,a=(c*t+p)*4;y[a]=s[M],y[a+1]=s[M+1],y[a+2]=s[M+2],y[a+3]=s[M+3]}return f}function Z(n,t,o){const s=n.data,f=new ImageData(t,o),y=f.data;if(t<n.width&&o<n.height){const c=n.width/t,p=n.height/o;for(let m=0;m<o;m++)for(let r=0;r<t;r++){const M=r*c,a=m*p,h=c,g=p;let x=0,b=0,i=0,e=0,w=0;const C=Math.floor(M),k=Math.floor(a),R=Math.min(Math.ceil(M+h),n.width),I=Math.min(Math.ceil(a+g),n.height);for(let E=k;E<I;E++)for(let L=C;L<R;L++){const q=Math.min(L+1,M+h)-Math.max(L,M),S=Math.min(E+1,a+g)-Math.max(E,a),v=q*S;if(v<=0)continue;const z=(E*n.width+L)*4;x+=s[z]*v,b+=s[z+1]*v,i+=s[z+2]*v,e+=s[z+3]*v,w+=v}const u=(m*t+r)*4;w>0&&(y[u]=x/w,y[u+1]=b/w,y[u+2]=i/w,y[u+3]=e/w)}return f}const l=(n.width-1)/t,d=(n.height-1)/o;for(let c=0;c<o;c++)for(let p=0;p<t;p++){const m=p*l,r=c*d,M=Math.floor(m),a=Math.floor(r),h=Math.min(M+1,n.width-1),g=Math.min(a+1,n.height-1),x=m-M,b=r-a,i=(c*t+p)*4;for(let e=0;e<4;e++){const w=s[(a*n.width+M)*4+e],C=s[(a*n.width+h)*4+e],k=s[(g*n.width+M)*4+e],R=s[(g*n.width+h)*4+e],I=w*(1-x)+C*x,u=k*(1-x)+R*x,E=I*(1-b)+u*b;y[i+e]=Math.round(E)}}return f}function tt(n,t,o){const s=n.data,f=n.width,y=n.height,l=new Float32Array(t*y*4),d=i=>{if(i=Math.abs(i),i===0)return 1;const e=Math.PI*i;return Math.sin(e)/e},c=(i,e)=>i>-e&&i<e?d(i)*d(i/e):0,p=3,m=f/t,r=m>1?m:1,M=p*r;for(let i=0;i<y;i++)for(let e=0;e<t;e++){const w=(e+.5)*m-.5;let C=0,k=0,R=0,I=0,u=0;const E=Math.floor(w-M+1),L=Math.floor(w+M);for(let S=E;S<=L;S++){if(S<0||S>=f)continue;const v=c((w-S)/r,p);if(v===0)continue;const z=(i*f+S)*4;C+=s[z]*v,k+=s[z+1]*v,R+=s[z+2]*v,I+=s[z+3]*v,u+=v}const q=(i*t+e)*4;u>0&&(l[q]=C/u,l[q+1]=k/u,l[q+2]=R/u,l[q+3]=I/u)}const a=new ImageData(t,o),h=a.data,g=y/o,x=g>1?g:1,b=p*x;for(let i=0;i<t;i++)for(let e=0;e<o;e++){const w=(e+.5)*g-.5;let C=0,k=0,R=0,I=0,u=0;const E=Math.floor(w-b+1),L=Math.floor(w+b);for(let S=E;S<=L;S++){if(S<0||S>=y)continue;const v=c((w-S)/x,p);if(v===0)continue;const z=(S*t+i)*4;C+=l[z]*v,k+=l[z+1]*v,R+=l[z+2]*v,I+=l[z+3]*v,u+=v}const q=(e*t+i)*4;u>0&&(h[q]=Math.max(0,Math.min(255,C/u)),h[q+1]=Math.max(0,Math.min(255,k/u)),h[q+2]=Math.max(0,Math.min(255,R/u)),h[q+3]=Math.max(0,Math.min(255,I/u)))}return a}const O={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},nt={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}],atkinson:[{dx:1,dy:0,f:1/8},{dx:2,dy:0,f:1/8},{dx:-1,dy:1,f:1/8},{dx:0,dy:1,f:1/8},{dx:1,dy:1,f:1/8},{dx:0,dy:2,f:1/8}]};function A(n,t,o,s,f,y,l){const d=Math.max(0,Math.min(255,Math.round(n.r))),c=Math.max(0,Math.min(255,Math.round(n.g))),p=Math.max(0,Math.min(255,Math.round(n.b))),m=d<<16|c<<8|p;if(l){const x=l.get(m);if(x)return x}let r=1/0,M=t[0],a=0;const h={r:d,g:c,b:p};if(f==="oklab"){const x=T(h);for(let b=0;b<t.length;b++){const i=J(x,s[b]);i<r&&(r=i,M=t[b],a=b)}}else if(f==="redmean")for(let x=0;x<t.length;x++){const b=N(h,t[x]);b<r&&(r=b,M=t[x],a=x)}else{const x=H(h),b=f==="ciede2000"?D:f==="cie94"?j:B;for(let i=0;i<t.length;i++){const e=b(x,o[i]);e<r&&(r=e,M=t[i],a=i)}}let g;return y>0&&r<=y?g={color:h,dist:0,index:a}:g={color:M,dist:r,index:a},l&&l.set(m,g),g}function ot(n,t,o,s,f="oklab",y=0){const l=n.data,d=n.width,c=n.height,p=t.map(W),m=p.map(H),r=f==="oklab"?p.map(T):null,M=new Map,a=s/100;if(o in O){const h=O[o],g=h.matrix,x=h.size,b=h.divisor,i=64;for(let e=0;e<c;e++)for(let w=0;w<d;w++){const C=(e*d+w)*4;if(l[C+3]<128){l[C+3]=0;continue}const k=w%x,R=e%x,u=(g[R][k]/b-.5)*i*a,E={r:Math.max(0,Math.min(255,l[C]+u)),g:Math.max(0,Math.min(255,l[C+1]+u)),b:Math.max(0,Math.min(255,l[C+2]+u))},{color:L}=A(E,p,m,r,f,y,M);l[C]=L.r,l[C+1]=L.g,l[C+2]=L.b,l[C+3]=255}}else{const h=new Float32Array(l),g=nt[o];for(let x=0;x<c;x++)for(let b=0;b<d;b++){const i=(x*d+b)*4;if(h[i+3]<128){l[i+3]=0;continue}const e={r:h[i],g:h[i+1],b:h[i+2]},{color:w}=A(e,p,m,r,f,y,M);if(l[i]=w.r,l[i+1]=w.g,l[i+2]=w.b,l[i+3]=255,o==="none"||!g)continue;const C={r:(e.r-w.r)*a,g:(e.g-w.g)*a,b:(e.b-w.b)*a};for(const k of g){const R=b+k.dx,I=x+k.dy;if(R>=0&&R<d&&I>=0&&I<c){const u=(I*d+R)*4;if(h[u+3]<128)continue;h[u]+=C.r*k.f,h[u+1]+=C.g*k.f,h[u+2]+=C.b*k.f}}}}}function U(n,t,o=20){return new Promise(s=>{if(t>n.length&&(t=n.length),t===0){s({centroids:[],assignments:[]});return}let f=[];const y=[...n];for(let d=0;d<t;d++){const c=Math.floor(Math.random()*y.length);f.push(y.splice(c,1)[0])}let l=new Array(n.length);for(let d=0;d<o;d++){for(let r=0;r<n.length;r++){let M=1/0,a=-1;for(let h=0;h<t;h++){const g=(n[r][0]-f[h][0])**2+(n[r][1]-f[h][1])**2+(n[r][2]-f[h][2])**2;g<M&&(M=g,a=h)}l[r]=a}const c=Array.from({length:t},()=>[0,0,0]),p=new Array(t).fill(0);for(let r=0;r<n.length;r++){const M=l[r];c[M][0]+=n[r][0],c[M][1]+=n[r][1],c[M][2]+=n[r][2],p[M]++}for(let r=0;r<t;r++)p[r]>0?(c[r][0]/=p[r],c[r][1]/=p[r],c[r][2]/=p[r]):c[r]=n[Math.floor(Math.random()*n.length)];let m=!1;for(let r=0;r<t;r++)if(f[r][0]!==c[r][0]||f[r][1]!==c[r][1]||f[r][2]!==c[r][2]){m=!0;break}if(f=c,!m)break}s({centroids:f,assignments:l})})}function st(n){const t=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${t(n.r)}${t(n.g)}${t(n.b)}`.toUpperCase()}async function et(n,t,o,s=!1){if(t.length===0)return[];const y=t.map(W).map(H),l=n.data,d=[],c=l.length/4,m=Math.ceil(c/4096)*4;for(let e=0;e<l.length;e+=m)l[e+3]>128&&d.push([l[e],l[e+1],l[e+2]]);if(d.length===0)return[];let r=Math.min(128,d.length);s&&(r=Math.min(256,d.length));const M=await U(d,r),a=M.centroids,h=M.assignments,g=new Array(a.length).fill(0);for(const e of h)g[e]++;const x=[];for(let e=0;e<a.length;e++){const w=a[e],C=g[e];if(C===0)continue;const k={r:Math.round(w[0]),g:Math.round(w[1]),b:Math.round(w[2])},R=H(k);let I=1/0;for(const E of y){const L=K(R,E);L<I&&(I=L)}const u=I*C;x.push({hex:st(k),rgb:k,error:I,count:C,totalError:u})}if(x.sort((e,w)=>w.totalError-e.totalError),!s)return x.slice(0,o).map(e=>e.hex);const b=[],i=[30,20,12,6,3,0];for(const e of i){if(b.length>=o)break;for(const w of x){if(b.length>=o)break;if(!b.some(C=>C.hex===w.hex))if(b.length===0)b.push(w);else{let C=!0;const k=H(w.rgb);for(const R of b){const I=H(R.rgb);if(K(k,I)<e){C=!1;break}}C&&b.push(w)}}}return b.map(e=>e.hex)}function rt(n,t,o,s){const f=n.data,y=n.width,l=n.height,d=new ImageData(new Uint8ClampedArray(f),y,l),c=d.data,p=259*(o+255)/(255*(259-o));for(let m=0;m<c.length;m+=4){let r=c[m],M=c[m+1],a=c[m+2];if(r+=t,M+=t,a+=t,r=p*(r-128)+128,M=p*(M-128)+128,a=p*(a-128)+128,s!==0){const h=.2989*r+.587*M+.114*a,g=1+s/100;r=h+(r-h)*g,M=h+(M-h)*g,a=h+(a-h)*g}c[m]=Math.max(0,Math.min(255,r)),c[m+1]=Math.max(0,Math.min(255,M)),c[m+2]=Math.max(0,Math.min(255,a))}return d}function ct(n,t){const o=n.data,s=n.width,f=n.height,y=new ImageData(new Uint8ClampedArray(o),s,f),l=y.data,d=Math.max(1,Math.floor(t/100*10));for(let c=0;c<f;c++)for(let p=0;p<s;p++){const m=(c*s+p)*4,r=[],M=[],a=[];for(let g=-d;g<=d;g++)for(let x=-d;x<=d;x++){const b=Math.min(f-1,Math.max(0,c+g)),i=Math.min(s-1,Math.max(0,p+x)),e=(b*s+i)*4;r.push(o[e]),M.push(o[e+1]),a.push(o[e+2])}r.sort((g,x)=>g-x),M.sort((g,x)=>g-x),a.sort((g,x)=>g-x);const h=Math.floor(r.length/2);l[m]=r[h],l[m+1]=M[h],l[m+2]=a[h],l[m+3]=o[m+3]}return y}function at(n,t){const o=n.data,s=n.width,f=n.height,y=new ImageData(new Uint8ClampedArray(o),s,f),l=y.data,d=Math.max(2,Math.floor(t/100*12)),c=d/2,p=30+t*1.5,m=[];for(let a=-d;a<=d;a++)m.push(Math.exp(-(a*a)/(2*c*c)));const r=new Float32Array(256*3),M=-1/(2*p*p);for(let a=0;a<r.length;a++)r[a]=Math.exp(a*a*M);for(let a=0;a<f;a++)for(let h=0;h<s;h++){const g=(a*s+h)*4,x=o[g],b=o[g+1],i=o[g+2];let e=0,w=0,C=0,k=0;for(let R=-d;R<=d;R++){const I=a+R;if(I<0||I>=f)continue;const u=m[R+d];for(let E=-d;E<=d;E++){const L=h+E;if(L<0||L>=s)continue;const q=(I*s+L)*4,S=o[q],v=o[q+1],z=o[q+2],X=Math.abs(S-x)+Math.abs(v-b)+Math.abs(z-i),_=u*m[E+d]*Math.exp(X*X*M);e+=S*_,w+=v*_,C+=z*_,k+=_}}l[g]=e/k,l[g+1]=w/k,l[g+2]=C/k,l[g+3]=o[g+3]}return y}function it(n,t){const o=n.data,s=n.width,f=n.height,y=new ImageData(new Uint8ClampedArray(o),s,f),l=y.data,d=Math.max(2,Math.floor(t/100*14));for(let c=0;c<f;c++)for(let p=0;p<s;p++){const m=(c*s+p)*4;if(o[m+3]===0)continue;let r=1/0,M={r:o[m],g:o[m+1],b:o[m+2]};const a=[[-d,0,-d,0],[0,d,-d,0],[-d,0,0,d],[0,d,0,d]];for(let h=0;h<4;h++){const[g,x,b,i]=a[h];let e=0,w=0,C=0,k=0,R=0,I=0,u=0;for(let v=b;v<=i;v++){const z=c+v;if(!(z<0||z>=f))for(let X=g;X<=x;X++){const _=p+X;if(_<0||_>=s)continue;const P=(z*s+_)*4,Y=o[P],F=o[P+1],G=o[P+2];e+=Y,w+=F,C+=G,k+=Y*Y,R+=F*F,I+=G*G,u++}}if(u===0)continue;const E=e/u,L=w/u,q=C/u,S=(k+R+I)/u-(E*E+L*L+q*q);S<r&&(r=S,M={r:E,g:L,b:q})}l[m]=M.r,l[m+1]=M.g,l[m+2]=M.b,l[m+3]=o[m+3]}return y}self.onmessage=async n=>{const{type:t,imageData:o,settings:s}=n.data;if(t==="suggest"){try{const{palette:R,numSuggestions:I,preferDistinct:u}=s,E=await et(o,R,I||5,u||!1);self.postMessage({type:"suggestions",suggestions:E})}catch(R){self.postMessage({type:"error",message:R.message})}return}const{targetWidth:f,targetHeight:y,ditherMethod:l,ditherStrength:d,palette:c,resamplingMethod:p,useKmeans:m,kmeansColors:r,brightness:M,contrast:a,saturation:h,preprocessingMethod:g,preprocessingStrength:x,filterTrivialColors:b,trivialThreshold:i,colorMatchAlgorithm:e,preserveDetailThreshold:w}=s,C=e||"oklab",k=w||0;try{let R=c,I=o;if((M&&M!==0||a&&a!==0||h&&h!==0)&&(I=rt(o,M||0,a||0,h||0)),g&&g!=="none"){const L=x||50;g==="median"?I=ct(I,L):g==="bilateral"?I=at(I,L):g==="kuwahara"&&(I=it(I,L))}let u;if(p==="lanczos"?u=tt(I,f,y):p==="bilinear"?u=Z(I,f,y):u=Q(I,f,y),b&&c&&c.length>0){const L=typeof i=="number"&&i>0?i:.1,q=c.map(W),S=q.map(H),v=C==="oklab"?q.map(T):null,z=new Map,X=new Array(c.length).fill(0),_=u.data;let P=0;for(let Y=0;Y<_.length;Y+=4)if(_[Y+3]>128){P++;const F={r:_[Y],g:_[Y+1],b:_[Y+2]},{index:G}=A(F,q,S,v,C,0,z);X[G]++}P>0&&(R=c.filter((Y,F)=>X[F]/P*100>=L),R.length===0&&(R=c))}let E;if(m&&r>0){const L=u.data,q=[];for(let S=0;S<L.length;S+=4)L[S+3]>128&&q.push([L[S],L[S+1],L[S+2]]);if(q.length>0){const v=(await U(q,Math.min(r,q.length))).centroids.map(P=>({r:Math.round(P[0]),g:Math.round(P[1]),b:Math.round(P[2])}));E=v.map(P=>"#"+((1<<24)+(P.r<<16)+(P.g<<8)+P.b).toString(16).slice(1).toUpperCase());const z=v.map(H),X=C==="oklab"?v.map(T):null,_=new Map;for(let P=0;P<L.length;P+=4)if(L[P+3]>128){const Y={r:L[P],g:L[P+1],b:L[P+2]},{color:F}=A(Y,v,z,X,C,0,_);L[P]=F.r,L[P+1]=F.g,L[P+2]=F.b}}}R&&R.length>0&&ot(u,R,l,d,C,k),self.postMessage({type:"success",imageData:u,generatedPalette:E})}catch(R){self.postMessage({type:"error",message:R.message})}}})();
//# sourceMappingURL=pixelator.worker-5AFeYwEC.js.map
