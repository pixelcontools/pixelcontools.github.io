(function(){"use strict";function W(t){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(t);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:{r:0,g:0,b:0}}function V(t){let n=t.r/255,o=t.g/255,s=t.b/255;return n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,n*=100,o*=100,s*=100,{x:n*.4124+o*.3576+s*.1805,y:n*.2126+o*.7152+s*.0722,z:n*.0193+o*.1192+s*.9505}}function $(t){let n=t.x/95.047,o=t.y/100,s=t.z/108.883;return n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(n-o),b:200*(o-s)}}function _(t){return $(V(t))}function A(t){let n=t.r/255,o=t.g/255,s=t.b/255;n=n>=.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,o=o>=.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>=.04045?Math.pow((s+.055)/1.055,2.4):s/12.92;const M=.4122214708*n+.5363325363*o+.0514459929*s,m=.2119034982*n+.6806995451*o+.1073969566*s,a=.0883024619*n+.2817188376*o+.6299787005*s,l=Math.cbrt(M),i=Math.cbrt(m),f=Math.cbrt(a);return{L:.2104542553*l+.793617785*i-.0040720468*f,a:1.9779984951*l-2.428592205*i+.4505937099*f,b:.0259040371*l+.7827717662*i-.808675766*f}}function B(t,n){const o=t.l-n.l,s=t.a-n.a,M=t.b-n.b;return Math.sqrt(o*o+s*s+M*M)}function D(t,n){const o=t.l-n.l,s=Math.sqrt(t.a*t.a+t.b*t.b),M=Math.sqrt(n.a*n.a+n.b*n.b),m=s-M,a=t.a-n.a,l=t.b-n.b;let i=a*a+l*l-m*m;i<0&&(i=0);const f=Math.sqrt(i),d=1,r=.045,g=.015,c=1,x=1+r*s,u=1+g*s,w=o/(d*c),I=m/x,h=f/u;return Math.sqrt(w*w+I*I+h*h)}function N(t,n){const o=t.l,s=t.a,M=t.b,m=n.l,a=n.a,l=n.b,i=Math.sqrt(s*s+M*M),f=Math.sqrt(a*a+l*l),d=(i+f)/2,r=Math.pow(d,7),g=.5*(1-Math.sqrt(r/(r+6103515625))),c=s*(1+g),x=a*(1+g),u=Math.sqrt(c*c+M*M),w=Math.sqrt(x*x+l*l),I=(u+w)/2;let h=Math.atan2(M,c)*(180/Math.PI);h<0&&(h+=360);let e=Math.atan2(l,x)*(180/Math.PI);e<0&&(e+=360);let y=m-o,v=w-u,L;u*w===0?L=0:Math.abs(e-h)<=180?L=e-h:e-h>180?L=e-h-360:L=e-h+360;const S=2*Math.sqrt(u*w)*Math.sin(L*Math.PI/180/2),b=(o+m)/2;let p;u*w===0?p=h+e:Math.abs(h-e)<=180?p=(h+e)/2:h+e<360?p=(h+e+360)/2:p=(h+e-360)/2;const k=1-.17*Math.cos((p-30)*Math.PI/180)+.24*Math.cos(2*p*Math.PI/180)+.32*Math.cos((3*p+6)*Math.PI/180)-.2*Math.cos((4*p-63)*Math.PI/180),C=1+.015*(b-50)*(b-50)/Math.sqrt(20+(b-50)*(b-50)),q=1+.045*I,E=1+.015*I*k,R=Math.pow(I,7),P=-2*Math.sqrt(R/(R+6103515625))*Math.sin(60*Math.PI/180*Math.exp(-((p-275)/25)*((p-275)/25))),X=y/C,z=v/q,Y=S/E;return Math.sqrt(X*X+z*z+Y*Y+P*z*Y)}function j(t,n){const o=t.L-n.L,s=t.a-n.a,M=t.b-n.b;return Math.sqrt(o*o+s*s+M*M)*100}const K=B;function J(t,n,o){const s=t.data,M=new ImageData(n,o),m=M.data,a=t.width/n,l=t.height/o;for(let i=0;i<o;i++)for(let f=0;f<n;f++){const d=Math.floor(f*a),g=(Math.floor(i*l)*t.width+d)*4,c=(i*n+f)*4;m[c]=s[g],m[c+1]=s[g+1],m[c+2]=s[g+2],m[c+3]=s[g+3]}return M}function Q(t,n,o){const s=t.data,M=new ImageData(n,o),m=M.data;if(n<t.width&&o<t.height){const i=t.width/n,f=t.height/o;for(let d=0;d<o;d++)for(let r=0;r<n;r++){const g=r*i,c=d*f,x=i,u=f;let w=0,I=0,h=0,e=0,y=0;const v=Math.floor(g),L=Math.floor(c),S=Math.min(Math.ceil(g+x),t.width),b=Math.min(Math.ceil(c+u),t.height);for(let k=L;k<b;k++)for(let C=v;C<S;C++){const q=Math.min(C+1,g+x)-Math.max(C,g),E=Math.min(k+1,c+u)-Math.max(k,c),R=q*E;if(R<=0)continue;const P=(k*t.width+C)*4;w+=s[P]*R,I+=s[P+1]*R,h+=s[P+2]*R,e+=s[P+3]*R,y+=R}const p=(d*n+r)*4;y>0&&(m[p]=w/y,m[p+1]=I/y,m[p+2]=h/y,m[p+3]=e/y)}return M}const a=(t.width-1)/n,l=(t.height-1)/o;for(let i=0;i<o;i++)for(let f=0;f<n;f++){const d=f*a,r=i*l,g=Math.floor(d),c=Math.floor(r),x=Math.min(g+1,t.width-1),u=Math.min(c+1,t.height-1),w=d-g,I=r-c,h=(i*n+f)*4;for(let e=0;e<4;e++){const y=s[(c*t.width+g)*4+e],v=s[(c*t.width+x)*4+e],L=s[(u*t.width+g)*4+e],S=s[(u*t.width+x)*4+e],b=y*(1-w)+v*w,p=L*(1-w)+S*w,k=b*(1-I)+p*I;m[h+e]=Math.round(k)}}return M}function Z(t,n,o){const s=t.data,M=t.width,m=t.height,a=new Float32Array(n*m*4),l=h=>{if(h=Math.abs(h),h===0)return 1;const e=Math.PI*h;return Math.sin(e)/e},i=(h,e)=>h>-e&&h<e?l(h)*l(h/e):0,f=3,d=M/n,r=d>1?d:1,g=f*r;for(let h=0;h<m;h++)for(let e=0;e<n;e++){const y=(e+.5)*d-.5;let v=0,L=0,S=0,b=0,p=0;const k=Math.floor(y-g+1),C=Math.floor(y+g);for(let E=k;E<=C;E++){if(E<0||E>=M)continue;const R=i((y-E)/r,f);if(R===0)continue;const P=(h*M+E)*4;v+=s[P]*R,L+=s[P+1]*R,S+=s[P+2]*R,b+=s[P+3]*R,p+=R}const q=(h*n+e)*4;p>0&&(a[q]=v/p,a[q+1]=L/p,a[q+2]=S/p,a[q+3]=b/p)}const c=new ImageData(n,o),x=c.data,u=m/o,w=u>1?u:1,I=f*w;for(let h=0;h<n;h++)for(let e=0;e<o;e++){const y=(e+.5)*u-.5;let v=0,L=0,S=0,b=0,p=0;const k=Math.floor(y-I+1),C=Math.floor(y+I);for(let E=k;E<=C;E++){if(E<0||E>=m)continue;const R=i((y-E)/w,f);if(R===0)continue;const P=(E*n+h)*4;v+=a[P]*R,L+=a[P+1]*R,S+=a[P+2]*R,b+=a[P+3]*R,p+=R}const q=(e*n+h)*4;p>0&&(x[q]=Math.max(0,Math.min(255,v/p)),x[q+1]=Math.max(0,Math.min(255,L/p)),x[q+2]=Math.max(0,Math.min(255,S/p)),x[q+3]=Math.max(0,Math.min(255,b/p)))}return c}const U={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},tt={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function T(t,n,o,s,M,m){let a=1/0,l=n[0];if(M==="oklab"){const i=A(t);for(let f=0;f<n.length;f++){const d=j(i,s[f]);d<a&&(a=d,l=n[f])}}else{const i=_(t),f=M==="ciede2000"?N:M==="cie94"?D:B;for(let d=0;d<n.length;d++){const r=f(i,o[d]);r<a&&(a=r,l=n[d])}}return m>0&&a<=m?{color:t,dist:0}:{color:l,dist:a}}function nt(t,n,o,s,M="oklab",m=0){const a=t.data,l=t.width,i=t.height,f=n.map(W),d=f.map(_),r=M==="oklab"?f.map(A):null,g=s/100;if(o in U){const c=U[o],x=c.matrix,u=c.size,w=c.divisor,I=64;for(let h=0;h<i;h++)for(let e=0;e<l;e++){const y=(h*l+e)*4;if(a[y+3]<128){a[y+3]=0;continue}const v=e%u,L=h%u,b=(x[L][v]/w-.5)*I*g,p={r:Math.max(0,Math.min(255,a[y]+b)),g:Math.max(0,Math.min(255,a[y+1]+b)),b:Math.max(0,Math.min(255,a[y+2]+b))},{color:k}=T(p,f,d,r,M,m);a[y]=k.r,a[y+1]=k.g,a[y+2]=k.b,a[y+3]=255}}else{const c=new Float32Array(a),x=tt[o];for(let u=0;u<i;u++)for(let w=0;w<l;w++){const I=(u*l+w)*4;if(c[I+3]<128){a[I+3]=0;continue}const h={r:c[I],g:c[I+1],b:c[I+2]},{color:e}=T(h,f,d,r,M,m);if(a[I]=e.r,a[I+1]=e.g,a[I+2]=e.b,a[I+3]=255,o==="none"||!x)continue;const y={r:(h.r-e.r)*g,g:(h.g-e.g)*g,b:(h.b-e.b)*g};for(const v of x){const L=w+v.dx,S=u+v.dy;if(L>=0&&L<l&&S>=0&&S<i){const b=(S*l+L)*4;if(c[b+3]<128)continue;c[b]+=y.r*v.f,c[b+1]+=y.g*v.f,c[b+2]+=y.b*v.f}}}}}function O(t,n,o=20){return new Promise(s=>{if(n>t.length&&(n=t.length),n===0){s({centroids:[],assignments:[]});return}let M=[];const m=[...t];for(let l=0;l<n;l++){const i=Math.floor(Math.random()*m.length);M.push(m.splice(i,1)[0])}let a=new Array(t.length);for(let l=0;l<o;l++){for(let r=0;r<t.length;r++){let g=1/0,c=-1;for(let x=0;x<n;x++){const u=(t[r][0]-M[x][0])**2+(t[r][1]-M[x][1])**2+(t[r][2]-M[x][2])**2;u<g&&(g=u,c=x)}a[r]=c}const i=Array.from({length:n},()=>[0,0,0]),f=new Array(n).fill(0);for(let r=0;r<t.length;r++){const g=a[r];i[g][0]+=t[r][0],i[g][1]+=t[r][1],i[g][2]+=t[r][2],f[g]++}for(let r=0;r<n;r++)f[r]>0?(i[r][0]/=f[r],i[r][1]/=f[r],i[r][2]/=f[r]):i[r]=t[Math.floor(Math.random()*t.length)];let d=!1;for(let r=0;r<n;r++)if(M[r][0]!==i[r][0]||M[r][1]!==i[r][1]||M[r][2]!==i[r][2]){d=!0;break}if(M=i,!d)break}s({centroids:M,assignments:a})})}function ot(t){const n=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${n(t.r)}${n(t.g)}${n(t.b)}`.toUpperCase()}async function st(t,n,o,s=!1){if(n.length===0)return[];const m=n.map(W).map(_),a=t.data,l=[],i=a.length/4,d=Math.ceil(i/4096)*4;for(let e=0;e<a.length;e+=d)a[e+3]>128&&l.push([a[e],a[e+1],a[e+2]]);if(l.length===0)return[];let r=Math.min(128,l.length);s&&(r=Math.min(256,l.length));const g=await O(l,r),c=g.centroids,x=g.assignments,u=new Array(c.length).fill(0);for(const e of x)u[e]++;const w=[];for(let e=0;e<c.length;e++){const y=c[e],v=u[e];if(v===0)continue;const L={r:Math.round(y[0]),g:Math.round(y[1]),b:Math.round(y[2])},S=_(L);let b=1/0;for(const k of m){const C=K(S,k);C<b&&(b=C)}const p=b*v;w.push({hex:ot(L),rgb:L,error:b,count:v,totalError:p})}if(w.sort((e,y)=>y.totalError-e.totalError),!s)return w.slice(0,o).map(e=>e.hex);const I=[],h=30;for(const e of w){if(I.length>=o)break;if(I.length===0)I.push(e);else{let y=!0;const v=_(e.rgb);for(const L of I){const S=_(L.rgb);if(K(v,S)<h){y=!1;break}}y&&I.push(e)}}return I.map(e=>e.hex)}function et(t,n,o,s){const M=t.data,m=t.width,a=t.height,l=new ImageData(new Uint8ClampedArray(M),m,a),i=l.data,f=259*(o+255)/(255*(259-o));for(let d=0;d<i.length;d+=4){let r=i[d],g=i[d+1],c=i[d+2];if(r+=n,g+=n,c+=n,r=f*(r-128)+128,g=f*(g-128)+128,c=f*(c-128)+128,s!==0){const x=.2989*r+.587*g+.114*c,u=1+s/100;r=x+(r-x)*u,g=x+(g-x)*u,c=x+(c-x)*u}i[d]=Math.max(0,Math.min(255,r)),i[d+1]=Math.max(0,Math.min(255,g)),i[d+2]=Math.max(0,Math.min(255,c))}return l}function rt(t,n){const o=t.data,s=t.width,M=t.height,m=new ImageData(new Uint8ClampedArray(o),s,M),a=m.data,l=Math.max(1,Math.floor(n/100*10));for(let i=0;i<M;i++)for(let f=0;f<s;f++){const d=(i*s+f)*4,r=[],g=[],c=[];for(let u=-l;u<=l;u++)for(let w=-l;w<=l;w++){const I=Math.min(M-1,Math.max(0,i+u)),h=Math.min(s-1,Math.max(0,f+w)),e=(I*s+h)*4;r.push(o[e]),g.push(o[e+1]),c.push(o[e+2])}r.sort((u,w)=>u-w),g.sort((u,w)=>u-w),c.sort((u,w)=>u-w);const x=Math.floor(r.length/2);a[d]=r[x],a[d+1]=g[x],a[d+2]=c[x],a[d+3]=o[d+3]}return m}function ct(t,n){const o=t.data,s=t.width,M=t.height,m=new ImageData(new Uint8ClampedArray(o),s,M),a=m.data,l=Math.max(2,Math.floor(n/100*12)),i=l/2,f=30+n*1.5,d=[];for(let c=-l;c<=l;c++)d.push(Math.exp(-(c*c)/(2*i*i)));const r=new Float32Array(256*3),g=-1/(2*f*f);for(let c=0;c<r.length;c++)r[c]=Math.exp(c*c*g);for(let c=0;c<M;c++)for(let x=0;x<s;x++){const u=(c*s+x)*4,w=o[u],I=o[u+1],h=o[u+2];let e=0,y=0,v=0,L=0;for(let S=-l;S<=l;S++){const b=c+S;if(b<0||b>=M)continue;const p=d[S+l];for(let k=-l;k<=l;k++){const C=x+k;if(C<0||C>=s)continue;const q=(b*s+C)*4,E=o[q],R=o[q+1],P=o[q+2],X=Math.abs(E-w)+Math.abs(R-I)+Math.abs(P-h),z=p*d[k+l]*Math.exp(X*X*g);e+=E*z,y+=R*z,v+=P*z,L+=z}}a[u]=e/L,a[u+1]=y/L,a[u+2]=v/L,a[u+3]=o[u+3]}return m}function at(t,n){const o=t.data,s=t.width,M=t.height,m=new ImageData(new Uint8ClampedArray(o),s,M),a=m.data,l=Math.max(2,Math.floor(n/100*14));for(let i=0;i<M;i++)for(let f=0;f<s;f++){const d=(i*s+f)*4;if(o[d+3]===0)continue;let r=1/0,g={r:o[d],g:o[d+1],b:o[d+2]};const c=[[-l,0,-l,0],[0,l,-l,0],[-l,0,0,l],[0,l,0,l]];for(let x=0;x<4;x++){const[u,w,I,h]=c[x];let e=0,y=0,v=0,L=0,S=0,b=0,p=0;for(let R=I;R<=h;R++){const P=i+R;if(!(P<0||P>=M))for(let X=u;X<=w;X++){const z=f+X;if(z<0||z>=s)continue;const Y=(P*s+z)*4,H=o[Y],G=o[Y+1],F=o[Y+2];e+=H,y+=G,v+=F,L+=H*H,S+=G*G,b+=F*F,p++}}if(p===0)continue;const k=e/p,C=y/p,q=v/p,E=(L+S+b)/p-(k*k+C*C+q*q);E<r&&(r=E,g={r:k,g:C,b:q})}a[d]=g.r,a[d+1]=g.g,a[d+2]=g.b,a[d+3]=o[d+3]}return m}self.onmessage=async t=>{const{type:n,imageData:o,settings:s}=t.data;if(n==="suggest"){try{const{palette:S,numSuggestions:b,preferDistinct:p}=s,k=await st(o,S,b||5,p||!1);self.postMessage({type:"suggestions",suggestions:k})}catch(S){self.postMessage({type:"error",message:S.message})}return}const{targetWidth:M,targetHeight:m,ditherMethod:a,ditherStrength:l,palette:i,resamplingMethod:f,useKmeans:d,kmeansColors:r,brightness:g,contrast:c,saturation:x,preprocessingMethod:u,preprocessingStrength:w,filterTrivialColors:I,colorStats:h,colorMatchAlgorithm:e,preserveDetailThreshold:y}=s,v=e||"oklab",L=y||0;try{let S=i;if(I&&h&&Array.isArray(h)&&h.length>0){const C=new Map(h.map(q=>[q.color,q.percent]));S=i.filter(q=>{const E=C.get(q);return E?E>=.1:!1}),S.length===0&&(S=i)}let b=o;if((g&&g!==0||c&&c!==0||x&&x!==0)&&(b=et(o,g||0,c||0,x||0)),u&&u!=="none"){const C=w||50;u==="median"?b=rt(b,C):u==="bilateral"?b=ct(b,C):u==="kuwahara"&&(b=at(b,C))}let p;f==="lanczos"?p=Z(b,M,m):f==="bilinear"?p=Q(b,M,m):p=J(b,M,m);let k;if(d&&r>0){const C=p.data,q=[];for(let E=0;E<C.length;E+=4)C[E+3]>128&&q.push([C[E],C[E+1],C[E+2]]);if(q.length>0){const R=(await O(q,Math.min(r,q.length))).centroids.map(z=>({r:Math.round(z[0]),g:Math.round(z[1]),b:Math.round(z[2])}));k=R.map(z=>"#"+((1<<24)+(z.r<<16)+(z.g<<8)+z.b).toString(16).slice(1).toUpperCase());const P=R.map(_),X=v==="oklab"?R.map(A):null;for(let z=0;z<C.length;z+=4)if(C[z+3]>128){const Y={r:C[z],g:C[z+1],b:C[z+2]},{color:H}=T(Y,R,P,X,v,0);C[z]=H.r,C[z+1]=H.g,C[z+2]=H.b}}}S&&S.length>0&&nt(p,S,a,l,v,L),self.postMessage({type:"success",imageData:p,generatedPalette:k})}catch(S){self.postMessage({type:"error",message:S.message})}}})();
//# sourceMappingURL=pixelator.worker-x56NY8r0.js.map
