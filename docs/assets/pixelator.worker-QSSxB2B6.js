(function(){"use strict";function W(n){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function V(n){let t=n.r/255,o=n.g/255,s=n.b/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,t*=100,o*=100,s*=100,{x:t*.4124+o*.3576+s*.1805,y:t*.2126+o*.7152+s*.0722,z:t*.0193+o*.1192+s*.9505}}function $(n){let t=n.x/95.047,o=n.y/100,s=n.z/108.883;return t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(t-o),b:200*(o-s)}}function H(n){return $(V(n))}function G(n){let t=n.r/255,o=n.g/255,s=n.b/255;t=t>=.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>=.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>=.04045?Math.pow((s+.055)/1.055,2.4):s/12.92;const h=.4122214708*t+.5363325363*o+.0514459929*s,y=.2119034982*t+.6806995451*o+.1073969566*s,i=.0883024619*t+.2817188376*o+.6299787005*s,d=Math.cbrt(h),a=Math.cbrt(y),x=Math.cbrt(i);return{L:.2104542553*d+.793617785*a-.0040720468*x,a:1.9779984951*d-2.428592205*a+.4505937099*x,b:.0259040371*d+.7827717662*a-.808675766*x}}function B(n,t){const o=n.l-t.l,s=n.a-t.a,h=n.b-t.b;return Math.sqrt(o*o+s*s+h*h)}function N(n,t){const o=(n.r+t.r)/2,s=n.r-t.r,h=n.g-t.g,y=n.b-t.b;return Math.sqrt((2+o/256)*s*s+4*h*h+(2+(255-o)/256)*y*y)}function j(n,t){const o=n.l-t.l,s=Math.sqrt(n.a*n.a+n.b*n.b),h=Math.sqrt(t.a*t.a+t.b*t.b),y=s-h,i=n.a-t.a,d=n.b-t.b;let a=i*i+d*d-y*y;a<0&&(a=0);const x=Math.sqrt(a),m=1,r=.045,g=.015,c=1,M=1+r*s,l=1+g*s,p=o/(m*c),w=y/M,f=x/l;return Math.sqrt(p*p+w*w+f*f)}function D(n,t){const o=n.l,s=n.a,h=n.b,y=t.l,i=t.a,d=t.b,a=Math.sqrt(s*s+h*h),x=Math.sqrt(i*i+d*d),m=(a+x)/2,r=Math.pow(m,7),g=.5*(1-Math.sqrt(r/(r+6103515625))),c=s*(1+g),M=i*(1+g),l=Math.sqrt(c*c+h*h),p=Math.sqrt(M*M+d*d),w=(l+p)/2;let f=Math.atan2(h,c)*(180/Math.PI);f<0&&(f+=360);let e=Math.atan2(d,M)*(180/Math.PI);e<0&&(e+=360);let b=y-o,L=p-l,S;l*p===0?S=0:Math.abs(e-f)<=180?S=e-f:e-f>180?S=e-f-360:S=e-f+360;const k=2*Math.sqrt(l*p)*Math.sin(S*Math.PI/180/2),C=(o+y)/2;let u;l*p===0?u=f+e:Math.abs(f-e)<=180?u=(f+e)/2:f+e<360?u=(f+e+360)/2:u=(f+e-360)/2;const R=1-.17*Math.cos((u-30)*Math.PI/180)+.24*Math.cos(2*u*Math.PI/180)+.32*Math.cos((3*u+6)*Math.PI/180)-.2*Math.cos((4*u-63)*Math.PI/180),E=1+.015*(C-50)*(C-50)/Math.sqrt(20+(C-50)*(C-50)),v=1+.045*w,z=1+.015*w*R,I=Math.pow(w,7),q=-2*Math.sqrt(I/(I+6103515625))*Math.sin(60*Math.PI/180*Math.exp(-((u-275)/25)*((u-275)/25))),Y=b/E,X=L/v,_=k/z;return Math.sqrt(Y*Y+X*X+_*_+q*X*_)}function J(n,t){const o=n.L-t.L,s=n.a-t.a,h=n.b-t.b;return Math.sqrt(o*o+s*s+h*h)*100}const K=B;function Q(n,t,o){const s=n.data,h=new ImageData(t,o),y=h.data,i=n.width/t,d=n.height/o;for(let a=0;a<o;a++)for(let x=0;x<t;x++){const m=Math.floor(x*i),g=(Math.floor(a*d)*n.width+m)*4,c=(a*t+x)*4;y[c]=s[g],y[c+1]=s[g+1],y[c+2]=s[g+2],y[c+3]=s[g+3]}return h}function Z(n,t,o){const s=n.data,h=new ImageData(t,o),y=h.data;if(t<n.width&&o<n.height){const a=n.width/t,x=n.height/o;for(let m=0;m<o;m++)for(let r=0;r<t;r++){const g=r*a,c=m*x,M=a,l=x;let p=0,w=0,f=0,e=0,b=0;const L=Math.floor(g),S=Math.floor(c),k=Math.min(Math.ceil(g+M),n.width),C=Math.min(Math.ceil(c+l),n.height);for(let R=S;R<C;R++)for(let E=L;E<k;E++){const v=Math.min(E+1,g+M)-Math.max(E,g),z=Math.min(R+1,c+l)-Math.max(R,c),I=v*z;if(I<=0)continue;const q=(R*n.width+E)*4;p+=s[q]*I,w+=s[q+1]*I,f+=s[q+2]*I,e+=s[q+3]*I,b+=I}const u=(m*t+r)*4;b>0&&(y[u]=p/b,y[u+1]=w/b,y[u+2]=f/b,y[u+3]=e/b)}return h}const i=(n.width-1)/t,d=(n.height-1)/o;for(let a=0;a<o;a++)for(let x=0;x<t;x++){const m=x*i,r=a*d,g=Math.floor(m),c=Math.floor(r),M=Math.min(g+1,n.width-1),l=Math.min(c+1,n.height-1),p=m-g,w=r-c,f=(a*t+x)*4;for(let e=0;e<4;e++){const b=s[(c*n.width+g)*4+e],L=s[(c*n.width+M)*4+e],S=s[(l*n.width+g)*4+e],k=s[(l*n.width+M)*4+e],C=b*(1-p)+L*p,u=S*(1-p)+k*p,R=C*(1-w)+u*w;y[f+e]=Math.round(R)}}return h}function tt(n,t,o){const s=n.data,h=n.width,y=n.height,i=new Float32Array(t*y*4),d=f=>{if(f=Math.abs(f),f===0)return 1;const e=Math.PI*f;return Math.sin(e)/e},a=(f,e)=>f>-e&&f<e?d(f)*d(f/e):0,x=3,m=h/t,r=m>1?m:1,g=x*r;for(let f=0;f<y;f++)for(let e=0;e<t;e++){const b=(e+.5)*m-.5;let L=0,S=0,k=0,C=0,u=0;const R=Math.floor(b-g+1),E=Math.floor(b+g);for(let z=R;z<=E;z++){if(z<0||z>=h)continue;const I=a((b-z)/r,x);if(I===0)continue;const q=(f*h+z)*4;L+=s[q]*I,S+=s[q+1]*I,k+=s[q+2]*I,C+=s[q+3]*I,u+=I}const v=(f*t+e)*4;u>0&&(i[v]=L/u,i[v+1]=S/u,i[v+2]=k/u,i[v+3]=C/u)}const c=new ImageData(t,o),M=c.data,l=y/o,p=l>1?l:1,w=x*p;for(let f=0;f<t;f++)for(let e=0;e<o;e++){const b=(e+.5)*l-.5;let L=0,S=0,k=0,C=0,u=0;const R=Math.floor(b-w+1),E=Math.floor(b+w);for(let z=R;z<=E;z++){if(z<0||z>=y)continue;const I=a((b-z)/p,x);if(I===0)continue;const q=(z*t+f)*4;L+=i[q]*I,S+=i[q+1]*I,k+=i[q+2]*I,C+=i[q+3]*I,u+=I}const v=(e*t+f)*4;u>0&&(M[v]=Math.max(0,Math.min(255,L/u)),M[v+1]=Math.max(0,Math.min(255,S/u)),M[v+2]=Math.max(0,Math.min(255,k/u)),M[v+3]=Math.max(0,Math.min(255,C/u)))}return c}const U={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},nt={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}],atkinson:[{dx:1,dy:0,f:1/8},{dx:2,dy:0,f:1/8},{dx:-1,dy:1,f:1/8},{dx:0,dy:1,f:1/8},{dx:1,dy:1,f:1/8},{dx:0,dy:2,f:1/8}]};function F(n,t,o,s,h,y,i){const d=Math.max(0,Math.min(255,Math.round(n.r))),a=Math.max(0,Math.min(255,Math.round(n.g))),x=Math.max(0,Math.min(255,Math.round(n.b))),m=d<<16|a<<8|x;if(i){const l=i.get(m);if(l)return l}let r=1/0,g=t[0];const c={r:d,g:a,b:x};if(h==="oklab"){const l=G(c);for(let p=0;p<t.length;p++){const w=J(l,s[p]);w<r&&(r=w,g=t[p])}}else if(h==="redmean")for(let l=0;l<t.length;l++){const p=N(c,t[l]);p<r&&(r=p,g=t[l])}else{const l=H(c),p=h==="ciede2000"?D:h==="cie94"?j:B;for(let w=0;w<t.length;w++){const f=p(l,o[w]);f<r&&(r=f,g=t[w])}}let M;return y>0&&r<=y?M={color:c,dist:0}:M={color:g,dist:r},i&&i.set(m,M),M}function ot(n,t,o,s,h="oklab",y=0){const i=n.data,d=n.width,a=n.height,x=t.map(W),m=x.map(H),r=h==="oklab"?x.map(G):null,g=new Map,c=s/100;if(o in U){const M=U[o],l=M.matrix,p=M.size,w=M.divisor,f=64;for(let e=0;e<a;e++)for(let b=0;b<d;b++){const L=(e*d+b)*4;if(i[L+3]<128){i[L+3]=0;continue}const S=b%p,k=e%p,u=(l[k][S]/w-.5)*f*c,R={r:Math.max(0,Math.min(255,i[L]+u)),g:Math.max(0,Math.min(255,i[L+1]+u)),b:Math.max(0,Math.min(255,i[L+2]+u))},{color:E}=F(R,x,m,r,h,y,g);i[L]=E.r,i[L+1]=E.g,i[L+2]=E.b,i[L+3]=255}}else{const M=new Float32Array(i),l=nt[o];for(let p=0;p<a;p++)for(let w=0;w<d;w++){const f=(p*d+w)*4;if(M[f+3]<128){i[f+3]=0;continue}const e={r:M[f],g:M[f+1],b:M[f+2]},{color:b}=F(e,x,m,r,h,y,g);if(i[f]=b.r,i[f+1]=b.g,i[f+2]=b.b,i[f+3]=255,o==="none"||!l)continue;const L={r:(e.r-b.r)*c,g:(e.g-b.g)*c,b:(e.b-b.b)*c};for(const S of l){const k=w+S.dx,C=p+S.dy;if(k>=0&&k<d&&C>=0&&C<a){const u=(C*d+k)*4;if(M[u+3]<128)continue;M[u]+=L.r*S.f,M[u+1]+=L.g*S.f,M[u+2]+=L.b*S.f}}}}}function O(n,t,o=20){return new Promise(s=>{if(t>n.length&&(t=n.length),t===0){s({centroids:[],assignments:[]});return}let h=[];const y=[...n];for(let d=0;d<t;d++){const a=Math.floor(Math.random()*y.length);h.push(y.splice(a,1)[0])}let i=new Array(n.length);for(let d=0;d<o;d++){for(let r=0;r<n.length;r++){let g=1/0,c=-1;for(let M=0;M<t;M++){const l=(n[r][0]-h[M][0])**2+(n[r][1]-h[M][1])**2+(n[r][2]-h[M][2])**2;l<g&&(g=l,c=M)}i[r]=c}const a=Array.from({length:t},()=>[0,0,0]),x=new Array(t).fill(0);for(let r=0;r<n.length;r++){const g=i[r];a[g][0]+=n[r][0],a[g][1]+=n[r][1],a[g][2]+=n[r][2],x[g]++}for(let r=0;r<t;r++)x[r]>0?(a[r][0]/=x[r],a[r][1]/=x[r],a[r][2]/=x[r]):a[r]=n[Math.floor(Math.random()*n.length)];let m=!1;for(let r=0;r<t;r++)if(h[r][0]!==a[r][0]||h[r][1]!==a[r][1]||h[r][2]!==a[r][2]){m=!0;break}if(h=a,!m)break}s({centroids:h,assignments:i})})}function st(n){const t=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${t(n.r)}${t(n.g)}${t(n.b)}`.toUpperCase()}async function et(n,t,o,s=!1){if(t.length===0)return[];const y=t.map(W).map(H),i=n.data,d=[],a=i.length/4,m=Math.ceil(a/4096)*4;for(let e=0;e<i.length;e+=m)i[e+3]>128&&d.push([i[e],i[e+1],i[e+2]]);if(d.length===0)return[];let r=Math.min(128,d.length);s&&(r=Math.min(256,d.length));const g=await O(d,r),c=g.centroids,M=g.assignments,l=new Array(c.length).fill(0);for(const e of M)l[e]++;const p=[];for(let e=0;e<c.length;e++){const b=c[e],L=l[e];if(L===0)continue;const S={r:Math.round(b[0]),g:Math.round(b[1]),b:Math.round(b[2])},k=H(S);let C=1/0;for(const R of y){const E=K(k,R);E<C&&(C=E)}const u=C*L;p.push({hex:st(S),rgb:S,error:C,count:L,totalError:u})}if(p.sort((e,b)=>b.totalError-e.totalError),!s)return p.slice(0,o).map(e=>e.hex);const w=[],f=[30,20,12,6,3,0];for(const e of f){if(w.length>=o)break;for(const b of p){if(w.length>=o)break;if(!w.some(L=>L.hex===b.hex))if(w.length===0)w.push(b);else{let L=!0;const S=H(b.rgb);for(const k of w){const C=H(k.rgb);if(K(S,C)<e){L=!1;break}}L&&w.push(b)}}}return w.map(e=>e.hex)}function rt(n,t,o,s){const h=n.data,y=n.width,i=n.height,d=new ImageData(new Uint8ClampedArray(h),y,i),a=d.data,x=259*(o+255)/(255*(259-o));for(let m=0;m<a.length;m+=4){let r=a[m],g=a[m+1],c=a[m+2];if(r+=t,g+=t,c+=t,r=x*(r-128)+128,g=x*(g-128)+128,c=x*(c-128)+128,s!==0){const M=.2989*r+.587*g+.114*c,l=1+s/100;r=M+(r-M)*l,g=M+(g-M)*l,c=M+(c-M)*l}a[m]=Math.max(0,Math.min(255,r)),a[m+1]=Math.max(0,Math.min(255,g)),a[m+2]=Math.max(0,Math.min(255,c))}return d}function ct(n,t){const o=n.data,s=n.width,h=n.height,y=new ImageData(new Uint8ClampedArray(o),s,h),i=y.data,d=Math.max(1,Math.floor(t/100*10));for(let a=0;a<h;a++)for(let x=0;x<s;x++){const m=(a*s+x)*4,r=[],g=[],c=[];for(let l=-d;l<=d;l++)for(let p=-d;p<=d;p++){const w=Math.min(h-1,Math.max(0,a+l)),f=Math.min(s-1,Math.max(0,x+p)),e=(w*s+f)*4;r.push(o[e]),g.push(o[e+1]),c.push(o[e+2])}r.sort((l,p)=>l-p),g.sort((l,p)=>l-p),c.sort((l,p)=>l-p);const M=Math.floor(r.length/2);i[m]=r[M],i[m+1]=g[M],i[m+2]=c[M],i[m+3]=o[m+3]}return y}function at(n,t){const o=n.data,s=n.width,h=n.height,y=new ImageData(new Uint8ClampedArray(o),s,h),i=y.data,d=Math.max(2,Math.floor(t/100*12)),a=d/2,x=30+t*1.5,m=[];for(let c=-d;c<=d;c++)m.push(Math.exp(-(c*c)/(2*a*a)));const r=new Float32Array(256*3),g=-1/(2*x*x);for(let c=0;c<r.length;c++)r[c]=Math.exp(c*c*g);for(let c=0;c<h;c++)for(let M=0;M<s;M++){const l=(c*s+M)*4,p=o[l],w=o[l+1],f=o[l+2];let e=0,b=0,L=0,S=0;for(let k=-d;k<=d;k++){const C=c+k;if(C<0||C>=h)continue;const u=m[k+d];for(let R=-d;R<=d;R++){const E=M+R;if(E<0||E>=s)continue;const v=(C*s+E)*4,z=o[v],I=o[v+1],q=o[v+2],Y=Math.abs(z-p)+Math.abs(I-w)+Math.abs(q-f),X=u*m[R+d]*Math.exp(Y*Y*g);e+=z*X,b+=I*X,L+=q*X,S+=X}}i[l]=e/S,i[l+1]=b/S,i[l+2]=L/S,i[l+3]=o[l+3]}return y}function it(n,t){const o=n.data,s=n.width,h=n.height,y=new ImageData(new Uint8ClampedArray(o),s,h),i=y.data,d=Math.max(2,Math.floor(t/100*14));for(let a=0;a<h;a++)for(let x=0;x<s;x++){const m=(a*s+x)*4;if(o[m+3]===0)continue;let r=1/0,g={r:o[m],g:o[m+1],b:o[m+2]};const c=[[-d,0,-d,0],[0,d,-d,0],[-d,0,0,d],[0,d,0,d]];for(let M=0;M<4;M++){const[l,p,w,f]=c[M];let e=0,b=0,L=0,S=0,k=0,C=0,u=0;for(let I=w;I<=f;I++){const q=a+I;if(!(q<0||q>=h))for(let Y=l;Y<=p;Y++){const X=x+Y;if(X<0||X>=s)continue;const _=(q*s+X)*4,P=o[_],T=o[_+1],A=o[_+2];e+=P,b+=T,L+=A,S+=P*P,k+=T*T,C+=A*A,u++}}if(u===0)continue;const R=e/u,E=b/u,v=L/u,z=(S+k+C)/u-(R*R+E*E+v*v);z<r&&(r=z,g={r:R,g:E,b:v})}i[m]=g.r,i[m+1]=g.g,i[m+2]=g.b,i[m+3]=o[m+3]}return y}self.onmessage=async n=>{const{type:t,imageData:o,settings:s}=n.data;if(t==="suggest"){try{const{palette:C,numSuggestions:u,preferDistinct:R}=s,E=await et(o,C,u||5,R||!1);self.postMessage({type:"suggestions",suggestions:E})}catch(C){self.postMessage({type:"error",message:C.message})}return}const{targetWidth:h,targetHeight:y,ditherMethod:i,ditherStrength:d,palette:a,resamplingMethod:x,useKmeans:m,kmeansColors:r,brightness:g,contrast:c,saturation:M,preprocessingMethod:l,preprocessingStrength:p,filterTrivialColors:w,trivialThreshold:f,colorStats:e,colorMatchAlgorithm:b,preserveDetailThreshold:L}=s,S=b||"oklab",k=L||0;try{let C=a;if(w&&e&&Array.isArray(e)&&e.length>0){const v=typeof f=="number"&&f>0?f:.1,z=new Map(e.map(I=>[I.color,I.percent]));C=a.filter(I=>{const q=z.get(I);return q?q>=v:!1}),C.length===0&&(C=a)}let u=o;if((g&&g!==0||c&&c!==0||M&&M!==0)&&(u=rt(o,g||0,c||0,M||0)),l&&l!=="none"){const v=p||50;l==="median"?u=ct(u,v):l==="bilateral"?u=at(u,v):l==="kuwahara"&&(u=it(u,v))}let R;x==="lanczos"?R=tt(u,h,y):x==="bilinear"?R=Z(u,h,y):R=Q(u,h,y);let E;if(m&&r>0){const v=R.data,z=[];for(let I=0;I<v.length;I+=4)v[I+3]>128&&z.push([v[I],v[I+1],v[I+2]]);if(z.length>0){const q=(await O(z,Math.min(r,z.length))).centroids.map(P=>({r:Math.round(P[0]),g:Math.round(P[1]),b:Math.round(P[2])}));E=q.map(P=>"#"+((1<<24)+(P.r<<16)+(P.g<<8)+P.b).toString(16).slice(1).toUpperCase());const Y=q.map(H),X=S==="oklab"?q.map(G):null,_=new Map;for(let P=0;P<v.length;P+=4)if(v[P+3]>128){const T={r:v[P],g:v[P+1],b:v[P+2]},{color:A}=F(T,q,Y,X,S,0,_);v[P]=A.r,v[P+1]=A.g,v[P+2]=A.b}}}C&&C.length>0&&ot(R,C,i,d,S,k),self.postMessage({type:"success",imageData:R,generatedPalette:E})}catch(C){self.postMessage({type:"error",message:C.message})}}})();
//# sourceMappingURL=pixelator.worker-QSSxB2B6.js.map
