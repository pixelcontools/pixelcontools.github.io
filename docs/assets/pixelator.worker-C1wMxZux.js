(function(){"use strict";function H(t){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(t);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:{r:0,g:0,b:0}}function K(t){let n=t.r/255,e=t.g/255,r=t.b/255;return n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92,n*=100,e*=100,r*=100,{x:n*.4124+e*.3576+r*.1805,y:n*.2126+e*.7152+r*.0722,z:n*.0193+e*.1192+r*.9505}}function V(t){let n=t.x/95.047,e=t.y/100,r=t.z/108.883;return n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,r=r>.008856?Math.pow(r,1/3):7.787*r+16/116,{l:116*e-16,a:500*(n-e),b:200*(e-r)}}function L(t){return V(K(t))}function W(t,n){const e=t.l-n.l,r=t.a-n.a,a=t.b-n.b;return Math.sqrt(e*e+r*r+a*a)}function $(t,n,e){const r=t.data,a=new ImageData(n,e),p=a.data,x=t.width/n,g=t.height/e;for(let f=0;f<e;f++)for(let u=0;u<n;u++){const c=Math.floor(u*x),l=(Math.floor(f*g)*t.width+c)*4,i=(f*n+u)*4;p[i]=r[l],p[i+1]=r[l+1],p[i+2]=r[l+2],p[i+3]=r[l+3]}return a}function N(t,n,e){const r=t.data,a=new ImageData(n,e),p=a.data;if(n<t.width&&e<t.height){const f=t.width/n,u=t.height/e;for(let c=0;c<e;c++)for(let s=0;s<n;s++){const l=s*f,i=c*u,h=f,d=u;let b=0,C=0,y=0,o=0,m=0;const I=Math.floor(l),v=Math.floor(i),M=Math.min(Math.ceil(l+h),t.width),S=Math.min(Math.ceil(i+d),t.height);for(let z=v;z<S;z++)for(let X=I;X<M;X++){const R=Math.min(X+1,l+h)-Math.max(X,l),B=Math.min(z+1,i+d)-Math.max(z,i),A=R*B;if(A<=0)continue;const Y=(z*t.width+X)*4;b+=r[Y]*A,C+=r[Y+1]*A,y+=r[Y+2]*A,o+=r[Y+3]*A,m+=A}const w=(c*n+s)*4;m>0&&(p[w]=b/m,p[w+1]=C/m,p[w+2]=y/m,p[w+3]=o/m)}return a}const x=(t.width-1)/n,g=(t.height-1)/e;for(let f=0;f<e;f++)for(let u=0;u<n;u++){const c=u*x,s=f*g,l=Math.floor(c),i=Math.floor(s),h=Math.min(l+1,t.width-1),d=Math.min(i+1,t.height-1),b=c-l,C=s-i,y=(f*n+u)*4;for(let o=0;o<4;o++){const m=r[(i*t.width+l)*4+o],I=r[(i*t.width+h)*4+o],v=r[(d*t.width+l)*4+o],M=r[(d*t.width+h)*4+o],S=m*(1-b)+I*b,w=v*(1-b)+M*b,z=S*(1-C)+w*C;p[y+o]=Math.round(z)}}return a}function j(t,n,e){const r=t.data,a=t.width,p=t.height,x=new Float32Array(n*p*4),g=y=>{if(y=Math.abs(y),y===0)return 1;const o=Math.PI*y;return Math.sin(o)/o},f=(y,o)=>y>-o&&y<o?g(y)*g(y/o):0,u=3,c=a/n,s=c>1?c:1,l=u*s;for(let y=0;y<p;y++)for(let o=0;o<n;o++){const m=(o+.5)*c-.5;let I=0,v=0,M=0,S=0,w=0;const z=Math.floor(m-l+1),X=Math.floor(m+l);for(let B=z;B<=X;B++){if(B<0||B>=a)continue;const A=f((m-B)/s,u);if(A===0)continue;const Y=(y*a+B)*4;I+=r[Y]*A,v+=r[Y+1]*A,M+=r[Y+2]*A,S+=r[Y+3]*A,w+=A}const R=(y*n+o)*4;w>0&&(x[R]=I/w,x[R+1]=v/w,x[R+2]=M/w,x[R+3]=S/w)}const i=new ImageData(n,e),h=i.data,d=p/e,b=d>1?d:1,C=u*b;for(let y=0;y<n;y++)for(let o=0;o<e;o++){const m=(o+.5)*d-.5;let I=0,v=0,M=0,S=0,w=0;const z=Math.floor(m-C+1),X=Math.floor(m+C);for(let B=z;B<=X;B++){if(B<0||B>=p)continue;const A=f((m-B)/b,u);if(A===0)continue;const Y=(B*n+y)*4;I+=x[Y]*A,v+=x[Y+1]*A,M+=x[Y+2]*A,S+=x[Y+3]*A,w+=A}const R=(o*n+y)*4;w>0&&(h[R]=Math.max(0,Math.min(255,I/w)),h[R+1]=Math.max(0,Math.min(255,v/w)),h[R+2]=Math.max(0,Math.min(255,M/w)),h[R+3]=Math.max(0,Math.min(255,S/w)))}return i}const U={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},D={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function k(t,n,e){const r=L(t);let a=1/0,p=n[0];for(let x=0;x<n.length;x++){const g=W(r,e[x]);g<a&&(a=g,p=n[x])}return p}function J(t,n,e,r){const a=t.data,p=t.width,x=t.height,g=n.map(H),f=g.map(L),u=r/100;if(e in U){const c=U[e],s=c.matrix,l=c.size,i=c.divisor,h=64;for(let d=0;d<x;d++)for(let b=0;b<p;b++){const C=(d*p+b)*4;if(a[C+3]<128){a[C+3]=0;continue}const y=b%l,o=d%l,I=(s[o][y]/i-.5)*h*u,v={r:Math.max(0,Math.min(255,a[C]+I)),g:Math.max(0,Math.min(255,a[C+1]+I)),b:Math.max(0,Math.min(255,a[C+2]+I))},M=k(v,g,f);a[C]=M.r,a[C+1]=M.g,a[C+2]=M.b,a[C+3]=255}}else{const c=new Float32Array(a),s=D[e];for(let l=0;l<x;l++)for(let i=0;i<p;i++){const h=(l*p+i)*4;if(c[h+3]<128){a[h+3]=0;continue}const d={r:c[h],g:c[h+1],b:c[h+2]},b=k(d,g,f);if(a[h]=b.r,a[h+1]=b.g,a[h+2]=b.b,a[h+3]=255,e==="none"||!s)continue;const C={r:(d.r-b.r)*u,g:(d.g-b.g)*u,b:(d.b-b.b)*u};for(const y of s){const o=i+y.dx,m=l+y.dy;if(o>=0&&o<p&&m>=0&&m<x){const I=(m*p+o)*4;if(c[I+3]<128)continue;c[I]+=C.r*y.f,c[I+1]+=C.g*y.f,c[I+2]+=C.b*y.f}}}}}function q(t,n,e=20){return new Promise(r=>{if(n>t.length&&(n=t.length),n===0){r({centroids:[],assignments:[]});return}let a=[];const p=[...t];for(let g=0;g<n;g++){const f=Math.floor(Math.random()*p.length);a.push(p.splice(f,1)[0])}let x=new Array(t.length);for(let g=0;g<e;g++){for(let s=0;s<t.length;s++){let l=1/0,i=-1;for(let h=0;h<n;h++){const d=(t[s][0]-a[h][0])**2+(t[s][1]-a[h][1])**2+(t[s][2]-a[h][2])**2;d<l&&(l=d,i=h)}x[s]=i}const f=Array.from({length:n},()=>[0,0,0]),u=new Array(n).fill(0);for(let s=0;s<t.length;s++){const l=x[s];f[l][0]+=t[s][0],f[l][1]+=t[s][1],f[l][2]+=t[s][2],u[l]++}for(let s=0;s<n;s++)u[s]>0?(f[s][0]/=u[s],f[s][1]/=u[s],f[s][2]/=u[s]):f[s]=t[Math.floor(Math.random()*t.length)];let c=!1;for(let s=0;s<n;s++)if(a[s][0]!==f[s][0]||a[s][1]!==f[s][1]||a[s][2]!==f[s][2]){c=!0;break}if(a=f,!c)break}r({centroids:a,assignments:x})})}function O(t){const n=e=>{const r=Math.round(e).toString(16);return r.length===1?"0"+r:r};return`#${n(t.r)}${n(t.g)}${n(t.b)}`.toUpperCase()}async function Q(t,n,e,r=!1){if(n.length===0)return[];const p=n.map(H).map(L),x=t.data,g=[],f=x.length/4,c=Math.ceil(f/4096)*4;for(let o=0;o<x.length;o+=c)x[o+3]>128&&g.push([x[o],x[o+1],x[o+2]]);if(g.length===0)return[];let s=Math.min(128,g.length);r&&(s=Math.min(256,g.length));const l=await q(g,s),i=l.centroids,h=l.assignments,d=new Array(i.length).fill(0);for(const o of h)d[o]++;const b=[];for(let o=0;o<i.length;o++){const m=i[o],I=d[o];if(I===0)continue;const v={r:Math.round(m[0]),g:Math.round(m[1]),b:Math.round(m[2])},M=L(v);let S=1/0;for(const z of p){const X=W(M,z);X<S&&(S=X)}const w=S*I;b.push({hex:O(v),rgb:v,error:S,count:I,totalError:w})}if(b.sort((o,m)=>m.totalError-o.totalError),!r)return b.slice(0,e).map(o=>o.hex);const C=[],y=30;for(const o of b){if(C.length>=e)break;if(C.length===0)C.push(o);else{let m=!0;const I=L(o.rgb);for(const v of C){const M=L(v.rgb);if(W(I,M)<y){m=!1;break}}m&&C.push(o)}}return C.map(o=>o.hex)}function Z(t,n,e,r){const a=t.data,p=t.width,x=t.height,g=new ImageData(new Uint8ClampedArray(a),p,x),f=g.data,u=259*(e+255)/(255*(259-e));for(let c=0;c<f.length;c+=4){let s=f[c],l=f[c+1],i=f[c+2];if(s+=n,l+=n,i+=n,s=u*(s-128)+128,l=u*(l-128)+128,i=u*(i-128)+128,r!==0){const h=.2989*s+.587*l+.114*i,d=1+r/100;s=h+(s-h)*d,l=h+(l-h)*d,i=h+(i-h)*d}f[c]=Math.max(0,Math.min(255,s)),f[c+1]=Math.max(0,Math.min(255,l)),f[c+2]=Math.max(0,Math.min(255,i))}return g}function tt(t,n){const e=t.data,r=t.width,a=t.height,p=new ImageData(new Uint8ClampedArray(e),r,a),x=p.data,g=Math.max(1,Math.floor(n/100*10));for(let f=0;f<a;f++)for(let u=0;u<r;u++){const c=(f*r+u)*4,s=[],l=[],i=[];for(let d=-g;d<=g;d++)for(let b=-g;b<=g;b++){const C=Math.min(a-1,Math.max(0,f+d)),y=Math.min(r-1,Math.max(0,u+b)),o=(C*r+y)*4;s.push(e[o]),l.push(e[o+1]),i.push(e[o+2])}s.sort((d,b)=>d-b),l.sort((d,b)=>d-b),i.sort((d,b)=>d-b);const h=Math.floor(s.length/2);x[c]=s[h],x[c+1]=l[h],x[c+2]=i[h],x[c+3]=e[c+3]}return p}function nt(t,n){const e=t.data,r=t.width,a=t.height,p=new ImageData(new Uint8ClampedArray(e),r,a),x=p.data,g=Math.max(2,Math.floor(n/100*12)),f=g/2,u=30+n*1.5,c=[];for(let i=-g;i<=g;i++)c.push(Math.exp(-(i*i)/(2*f*f)));const s=new Float32Array(256*3),l=-1/(2*u*u);for(let i=0;i<s.length;i++)s[i]=Math.exp(i*i*l);for(let i=0;i<a;i++)for(let h=0;h<r;h++){const d=(i*r+h)*4,b=e[d],C=e[d+1],y=e[d+2];let o=0,m=0,I=0,v=0;for(let M=-g;M<=g;M++){const S=i+M;if(S<0||S>=a)continue;const w=c[M+g];for(let z=-g;z<=g;z++){const X=h+z;if(X<0||X>=r)continue;const R=(S*r+X)*4,B=e[R],A=e[R+1],Y=e[R+2],G=Math.abs(B-b)+Math.abs(A-C)+Math.abs(Y-y),E=w*c[z+g]*Math.exp(G*G*l);o+=B*E,m+=A*E,I+=Y*E,v+=E}}x[d]=o/v,x[d+1]=m/v,x[d+2]=I/v,x[d+3]=e[d+3]}return p}function et(t,n){const e=t.data,r=t.width,a=t.height,p=new ImageData(new Uint8ClampedArray(e),r,a),x=p.data,g=Math.max(2,Math.floor(n/100*14));for(let f=0;f<a;f++)for(let u=0;u<r;u++){const c=(f*r+u)*4;if(e[c+3]===0)continue;let s=1/0,l={r:e[c],g:e[c+1],b:e[c+2]};const i=[[-g,0,-g,0],[0,g,-g,0],[-g,0,0,g],[0,g,0,g]];for(let h=0;h<4;h++){const[d,b,C,y]=i[h];let o=0,m=0,I=0,v=0,M=0,S=0,w=0;for(let A=C;A<=y;A++){const Y=f+A;if(!(Y<0||Y>=a))for(let G=d;G<=b;G++){const E=u+G;if(E<0||E>=r)continue;const F=(Y*r+E)*4,T=e[F],P=e[F+1],_=e[F+2];o+=T,m+=P,I+=_,v+=T*T,M+=P*P,S+=_*_,w++}}if(w===0)continue;const z=o/w,X=m/w,R=I/w,B=(v+M+S)/w-(z*z+X*X+R*R);B<s&&(s=B,l={r:z,g:X,b:R})}x[c]=l.r,x[c+1]=l.g,x[c+2]=l.b,x[c+3]=e[c+3]}return p}self.onmessage=async t=>{const{type:n,imageData:e,settings:r}=t.data;if(n==="suggest"){try{const{palette:o,numSuggestions:m,preferDistinct:I}=r,v=await Q(e,o,m||5,I||!1);self.postMessage({type:"suggestions",suggestions:v})}catch(o){self.postMessage({type:"error",message:o.message})}return}const{targetWidth:a,targetHeight:p,ditherMethod:x,ditherStrength:g,palette:f,resamplingMethod:u,useKmeans:c,kmeansColors:s,brightness:l,contrast:i,saturation:h,preprocessingMethod:d,preprocessingStrength:b,filterTrivialColors:C,colorStats:y}=r;try{let o=f;if(C&&y&&Array.isArray(y)&&y.length>0){const M=new Map(y.map(S=>[S.color,S.percent]));o=f.filter(S=>{const w=M.get(S);return w?w>=.1:!1}),o.length===0&&(o=f)}let m=e;if((l&&l!==0||i&&i!==0||h&&h!==0)&&(m=Z(e,l||0,i||0,h||0)),d&&d!=="none"){const M=b||50;d==="median"?m=tt(m,M):d==="bilateral"?m=nt(m,M):d==="kuwahara"&&(m=et(m,M))}let I;u==="lanczos"?I=j(m,a,p):u==="bilinear"?I=N(m,a,p):I=$(m,a,p);let v;if(c&&s>0){const M=I.data,S=[];for(let w=0;w<M.length;w+=4)M[w+3]>128&&S.push([M[w],M[w+1],M[w+2]]);if(S.length>0){const z=(await q(S,Math.min(s,S.length))).centroids.map(R=>({r:Math.round(R[0]),g:Math.round(R[1]),b:Math.round(R[2])}));v=z.map(R=>"#"+((1<<24)+(R.r<<16)+(R.g<<8)+R.b).toString(16).slice(1).toUpperCase());const X=z.map(L);for(let R=0;R<M.length;R+=4)if(M[R+3]>128){const B={r:M[R],g:M[R+1],b:M[R+2]},A=k(B,z,X);M[R]=A.r,M[R+1]=A.g,M[R+2]=A.b}}}o&&o.length>0&&J(I,o,x,g),self.postMessage({type:"success",imageData:I,generatedPalette:v})}catch(o){self.postMessage({type:"error",message:o.message})}}})();
//# sourceMappingURL=pixelator.worker-C1wMxZux.js.map
