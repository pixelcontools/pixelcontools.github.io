(function(){"use strict";function W(n){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function V(n){let t=n.r/255,o=n.g/255,s=n.b/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,t*=100,o*=100,s*=100,{x:t*.4124+o*.3576+s*.1805,y:t*.2126+o*.7152+s*.0722,z:t*.0193+o*.1192+s*.9505}}function $(n){let t=n.x/95.047,o=n.y/100,s=n.z/108.883;return t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(t-o),b:200*(o-s)}}function _(n){return $(V(n))}function T(n){let t=n.r/255,o=n.g/255,s=n.b/255;t=t>=.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>=.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>=.04045?Math.pow((s+.055)/1.055,2.4):s/12.92;const h=.4122214708*t+.5363325363*o+.0514459929*s,y=.2119034982*t+.6806995451*o+.1073969566*s,i=.0883024619*t+.2817188376*o+.6299787005*s,d=Math.cbrt(h),a=Math.cbrt(y),u=Math.cbrt(i);return{L:.2104542553*d+.793617785*a-.0040720468*u,a:1.9779984951*d-2.428592205*a+.4505937099*u,b:.0259040371*d+.7827717662*a-.808675766*u}}function B(n,t){const o=n.l-t.l,s=n.a-t.a,h=n.b-t.b;return Math.sqrt(o*o+s*s+h*h)}function D(n,t){const o=(n.r+t.r)/2,s=n.r-t.r,h=n.g-t.g,y=n.b-t.b;return Math.sqrt((2+o/256)*s*s+4*h*h+(2+(255-o)/256)*y*y)}function N(n,t){const o=n.l-t.l,s=Math.sqrt(n.a*n.a+n.b*n.b),h=Math.sqrt(t.a*t.a+t.b*t.b),y=s-h,i=n.a-t.a,d=n.b-t.b;let a=i*i+d*d-y*y;a<0&&(a=0);const u=Math.sqrt(a),m=1,e=.045,g=.015,c=1,M=1+e*s,l=1+g*s,p=o/(m*c),C=y/M,f=u/l;return Math.sqrt(p*p+C*C+f*f)}function j(n,t){const o=n.l,s=n.a,h=n.b,y=t.l,i=t.a,d=t.b,a=Math.sqrt(s*s+h*h),u=Math.sqrt(i*i+d*d),m=(a+u)/2,e=Math.pow(m,7),g=.5*(1-Math.sqrt(e/(e+6103515625))),c=s*(1+g),M=i*(1+g),l=Math.sqrt(c*c+h*h),p=Math.sqrt(M*M+d*d),C=(l+p)/2;let f=Math.atan2(h,c)*(180/Math.PI);f<0&&(f+=360);let r=Math.atan2(d,M)*(180/Math.PI);r<0&&(r+=360);let b=y-o,L=p-l,R;l*p===0?R=0:Math.abs(r-f)<=180?R=r-f:r-f>180?R=r-f-360:R=r-f+360;const S=2*Math.sqrt(l*p)*Math.sin(R*Math.PI/180/2),I=(o+y)/2;let x;l*p===0?x=f+r:Math.abs(f-r)<=180?x=(f+r)/2:f+r<360?x=(f+r+360)/2:x=(f+r-360)/2;const k=1-.17*Math.cos((x-30)*Math.PI/180)+.24*Math.cos(2*x*Math.PI/180)+.32*Math.cos((3*x+6)*Math.PI/180)-.2*Math.cos((4*x-63)*Math.PI/180),w=1+.015*(I-50)*(I-50)/Math.sqrt(20+(I-50)*(I-50)),q=1+.045*C,E=1+.015*C*k,v=Math.pow(C,7),z=-2*Math.sqrt(v/(v+6103515625))*Math.sin(60*Math.PI/180*Math.exp(-((x-275)/25)*((x-275)/25))),Y=b/w,X=L/q,P=S/E;return Math.sqrt(Y*Y+X*X+P*P+z*X*P)}function J(n,t){const o=n.L-t.L,s=n.a-t.a,h=n.b-t.b;return Math.sqrt(o*o+s*s+h*h)*100}const K=B;function Q(n,t,o){const s=n.data,h=new ImageData(t,o),y=h.data,i=n.width/t,d=n.height/o;for(let a=0;a<o;a++)for(let u=0;u<t;u++){const m=Math.floor(u*i),g=(Math.floor(a*d)*n.width+m)*4,c=(a*t+u)*4;y[c]=s[g],y[c+1]=s[g+1],y[c+2]=s[g+2],y[c+3]=s[g+3]}return h}function Z(n,t,o){const s=n.data,h=new ImageData(t,o),y=h.data;if(t<n.width&&o<n.height){const a=n.width/t,u=n.height/o;for(let m=0;m<o;m++)for(let e=0;e<t;e++){const g=e*a,c=m*u,M=a,l=u;let p=0,C=0,f=0,r=0,b=0;const L=Math.floor(g),R=Math.floor(c),S=Math.min(Math.ceil(g+M),n.width),I=Math.min(Math.ceil(c+l),n.height);for(let k=R;k<I;k++)for(let w=L;w<S;w++){const q=Math.min(w+1,g+M)-Math.max(w,g),E=Math.min(k+1,c+l)-Math.max(k,c),v=q*E;if(v<=0)continue;const z=(k*n.width+w)*4;p+=s[z]*v,C+=s[z+1]*v,f+=s[z+2]*v,r+=s[z+3]*v,b+=v}const x=(m*t+e)*4;b>0&&(y[x]=p/b,y[x+1]=C/b,y[x+2]=f/b,y[x+3]=r/b)}return h}const i=(n.width-1)/t,d=(n.height-1)/o;for(let a=0;a<o;a++)for(let u=0;u<t;u++){const m=u*i,e=a*d,g=Math.floor(m),c=Math.floor(e),M=Math.min(g+1,n.width-1),l=Math.min(c+1,n.height-1),p=m-g,C=e-c,f=(a*t+u)*4;for(let r=0;r<4;r++){const b=s[(c*n.width+g)*4+r],L=s[(c*n.width+M)*4+r],R=s[(l*n.width+g)*4+r],S=s[(l*n.width+M)*4+r],I=b*(1-p)+L*p,x=R*(1-p)+S*p,k=I*(1-C)+x*C;y[f+r]=Math.round(k)}}return h}function tt(n,t,o){const s=n.data,h=n.width,y=n.height,i=new Float32Array(t*y*4),d=f=>{if(f=Math.abs(f),f===0)return 1;const r=Math.PI*f;return Math.sin(r)/r},a=(f,r)=>f>-r&&f<r?d(f)*d(f/r):0,u=3,m=h/t,e=m>1?m:1,g=u*e;for(let f=0;f<y;f++)for(let r=0;r<t;r++){const b=(r+.5)*m-.5;let L=0,R=0,S=0,I=0,x=0;const k=Math.floor(b-g+1),w=Math.floor(b+g);for(let E=k;E<=w;E++){if(E<0||E>=h)continue;const v=a((b-E)/e,u);if(v===0)continue;const z=(f*h+E)*4;L+=s[z]*v,R+=s[z+1]*v,S+=s[z+2]*v,I+=s[z+3]*v,x+=v}const q=(f*t+r)*4;x>0&&(i[q]=L/x,i[q+1]=R/x,i[q+2]=S/x,i[q+3]=I/x)}const c=new ImageData(t,o),M=c.data,l=y/o,p=l>1?l:1,C=u*p;for(let f=0;f<t;f++)for(let r=0;r<o;r++){const b=(r+.5)*l-.5;let L=0,R=0,S=0,I=0,x=0;const k=Math.floor(b-C+1),w=Math.floor(b+C);for(let E=k;E<=w;E++){if(E<0||E>=y)continue;const v=a((b-E)/p,u);if(v===0)continue;const z=(E*t+f)*4;L+=i[z]*v,R+=i[z+1]*v,S+=i[z+2]*v,I+=i[z+3]*v,x+=v}const q=(r*t+f)*4;x>0&&(M[q]=Math.max(0,Math.min(255,L/x)),M[q+1]=Math.max(0,Math.min(255,R/x)),M[q+2]=Math.max(0,Math.min(255,S/x)),M[q+3]=Math.max(0,Math.min(255,I/x)))}return c}const U={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},nt={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function G(n,t,o,s,h,y,i){const d=Math.max(0,Math.min(255,Math.round(n.r))),a=Math.max(0,Math.min(255,Math.round(n.g))),u=Math.max(0,Math.min(255,Math.round(n.b))),m=d<<16|a<<8|u;if(i){const l=i.get(m);if(l)return l}let e=1/0,g=t[0];const c={r:d,g:a,b:u};if(h==="oklab"){const l=T(c);for(let p=0;p<t.length;p++){const C=J(l,s[p]);C<e&&(e=C,g=t[p])}}else if(h==="redmean")for(let l=0;l<t.length;l++){const p=D(c,t[l]);p<e&&(e=p,g=t[l])}else{const l=_(c),p=h==="ciede2000"?j:h==="cie94"?N:B;for(let C=0;C<t.length;C++){const f=p(l,o[C]);f<e&&(e=f,g=t[C])}}let M;return y>0&&e<=y?M={color:c,dist:0}:M={color:g,dist:e},i&&i.set(m,M),M}function ot(n,t,o,s,h="oklab",y=0){const i=n.data,d=n.width,a=n.height,u=t.map(W),m=u.map(_),e=h==="oklab"?u.map(T):null,g=new Map,c=s/100;if(o in U){const M=U[o],l=M.matrix,p=M.size,C=M.divisor,f=64;for(let r=0;r<a;r++)for(let b=0;b<d;b++){const L=(r*d+b)*4;if(i[L+3]<128){i[L+3]=0;continue}const R=b%p,S=r%p,x=(l[S][R]/C-.5)*f*c,k={r:Math.max(0,Math.min(255,i[L]+x)),g:Math.max(0,Math.min(255,i[L+1]+x)),b:Math.max(0,Math.min(255,i[L+2]+x))},{color:w}=G(k,u,m,e,h,y,g);i[L]=w.r,i[L+1]=w.g,i[L+2]=w.b,i[L+3]=255}}else{const M=new Float32Array(i),l=nt[o];for(let p=0;p<a;p++)for(let C=0;C<d;C++){const f=(p*d+C)*4;if(M[f+3]<128){i[f+3]=0;continue}const r={r:M[f],g:M[f+1],b:M[f+2]},{color:b}=G(r,u,m,e,h,y,g);if(i[f]=b.r,i[f+1]=b.g,i[f+2]=b.b,i[f+3]=255,o==="none"||!l)continue;const L={r:(r.r-b.r)*c,g:(r.g-b.g)*c,b:(r.b-b.b)*c};for(const R of l){const S=C+R.dx,I=p+R.dy;if(S>=0&&S<d&&I>=0&&I<a){const x=(I*d+S)*4;if(M[x+3]<128)continue;M[x]+=L.r*R.f,M[x+1]+=L.g*R.f,M[x+2]+=L.b*R.f}}}}}function O(n,t,o=20){return new Promise(s=>{if(t>n.length&&(t=n.length),t===0){s({centroids:[],assignments:[]});return}let h=[];const y=[...n];for(let d=0;d<t;d++){const a=Math.floor(Math.random()*y.length);h.push(y.splice(a,1)[0])}let i=new Array(n.length);for(let d=0;d<o;d++){for(let e=0;e<n.length;e++){let g=1/0,c=-1;for(let M=0;M<t;M++){const l=(n[e][0]-h[M][0])**2+(n[e][1]-h[M][1])**2+(n[e][2]-h[M][2])**2;l<g&&(g=l,c=M)}i[e]=c}const a=Array.from({length:t},()=>[0,0,0]),u=new Array(t).fill(0);for(let e=0;e<n.length;e++){const g=i[e];a[g][0]+=n[e][0],a[g][1]+=n[e][1],a[g][2]+=n[e][2],u[g]++}for(let e=0;e<t;e++)u[e]>0?(a[e][0]/=u[e],a[e][1]/=u[e],a[e][2]/=u[e]):a[e]=n[Math.floor(Math.random()*n.length)];let m=!1;for(let e=0;e<t;e++)if(h[e][0]!==a[e][0]||h[e][1]!==a[e][1]||h[e][2]!==a[e][2]){m=!0;break}if(h=a,!m)break}s({centroids:h,assignments:i})})}function st(n){const t=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${t(n.r)}${t(n.g)}${t(n.b)}`.toUpperCase()}async function et(n,t,o,s=!1){if(t.length===0)return[];const y=t.map(W).map(_),i=n.data,d=[],a=i.length/4,m=Math.ceil(a/4096)*4;for(let r=0;r<i.length;r+=m)i[r+3]>128&&d.push([i[r],i[r+1],i[r+2]]);if(d.length===0)return[];let e=Math.min(128,d.length);s&&(e=Math.min(256,d.length));const g=await O(d,e),c=g.centroids,M=g.assignments,l=new Array(c.length).fill(0);for(const r of M)l[r]++;const p=[];for(let r=0;r<c.length;r++){const b=c[r],L=l[r];if(L===0)continue;const R={r:Math.round(b[0]),g:Math.round(b[1]),b:Math.round(b[2])},S=_(R);let I=1/0;for(const k of y){const w=K(S,k);w<I&&(I=w)}const x=I*L;p.push({hex:st(R),rgb:R,error:I,count:L,totalError:x})}if(p.sort((r,b)=>b.totalError-r.totalError),!s)return p.slice(0,o).map(r=>r.hex);const C=[],f=30;for(const r of p){if(C.length>=o)break;if(C.length===0)C.push(r);else{let b=!0;const L=_(r.rgb);for(const R of C){const S=_(R.rgb);if(K(L,S)<f){b=!1;break}}b&&C.push(r)}}return C.map(r=>r.hex)}function rt(n,t,o,s){const h=n.data,y=n.width,i=n.height,d=new ImageData(new Uint8ClampedArray(h),y,i),a=d.data,u=259*(o+255)/(255*(259-o));for(let m=0;m<a.length;m+=4){let e=a[m],g=a[m+1],c=a[m+2];if(e+=t,g+=t,c+=t,e=u*(e-128)+128,g=u*(g-128)+128,c=u*(c-128)+128,s!==0){const M=.2989*e+.587*g+.114*c,l=1+s/100;e=M+(e-M)*l,g=M+(g-M)*l,c=M+(c-M)*l}a[m]=Math.max(0,Math.min(255,e)),a[m+1]=Math.max(0,Math.min(255,g)),a[m+2]=Math.max(0,Math.min(255,c))}return d}function ct(n,t){const o=n.data,s=n.width,h=n.height,y=new ImageData(new Uint8ClampedArray(o),s,h),i=y.data,d=Math.max(1,Math.floor(t/100*10));for(let a=0;a<h;a++)for(let u=0;u<s;u++){const m=(a*s+u)*4,e=[],g=[],c=[];for(let l=-d;l<=d;l++)for(let p=-d;p<=d;p++){const C=Math.min(h-1,Math.max(0,a+l)),f=Math.min(s-1,Math.max(0,u+p)),r=(C*s+f)*4;e.push(o[r]),g.push(o[r+1]),c.push(o[r+2])}e.sort((l,p)=>l-p),g.sort((l,p)=>l-p),c.sort((l,p)=>l-p);const M=Math.floor(e.length/2);i[m]=e[M],i[m+1]=g[M],i[m+2]=c[M],i[m+3]=o[m+3]}return y}function at(n,t){const o=n.data,s=n.width,h=n.height,y=new ImageData(new Uint8ClampedArray(o),s,h),i=y.data,d=Math.max(2,Math.floor(t/100*12)),a=d/2,u=30+t*1.5,m=[];for(let c=-d;c<=d;c++)m.push(Math.exp(-(c*c)/(2*a*a)));const e=new Float32Array(256*3),g=-1/(2*u*u);for(let c=0;c<e.length;c++)e[c]=Math.exp(c*c*g);for(let c=0;c<h;c++)for(let M=0;M<s;M++){const l=(c*s+M)*4,p=o[l],C=o[l+1],f=o[l+2];let r=0,b=0,L=0,R=0;for(let S=-d;S<=d;S++){const I=c+S;if(I<0||I>=h)continue;const x=m[S+d];for(let k=-d;k<=d;k++){const w=M+k;if(w<0||w>=s)continue;const q=(I*s+w)*4,E=o[q],v=o[q+1],z=o[q+2],Y=Math.abs(E-p)+Math.abs(v-C)+Math.abs(z-f),X=x*m[k+d]*Math.exp(Y*Y*g);r+=E*X,b+=v*X,L+=z*X,R+=X}}i[l]=r/R,i[l+1]=b/R,i[l+2]=L/R,i[l+3]=o[l+3]}return y}function it(n,t){const o=n.data,s=n.width,h=n.height,y=new ImageData(new Uint8ClampedArray(o),s,h),i=y.data,d=Math.max(2,Math.floor(t/100*14));for(let a=0;a<h;a++)for(let u=0;u<s;u++){const m=(a*s+u)*4;if(o[m+3]===0)continue;let e=1/0,g={r:o[m],g:o[m+1],b:o[m+2]};const c=[[-d,0,-d,0],[0,d,-d,0],[-d,0,0,d],[0,d,0,d]];for(let M=0;M<4;M++){const[l,p,C,f]=c[M];let r=0,b=0,L=0,R=0,S=0,I=0,x=0;for(let v=C;v<=f;v++){const z=a+v;if(!(z<0||z>=h))for(let Y=l;Y<=p;Y++){const X=u+Y;if(X<0||X>=s)continue;const P=(z*s+X)*4,A=o[P],H=o[P+1],F=o[P+2];r+=A,b+=H,L+=F,R+=A*A,S+=H*H,I+=F*F,x++}}if(x===0)continue;const k=r/x,w=b/x,q=L/x,E=(R+S+I)/x-(k*k+w*w+q*q);E<e&&(e=E,g={r:k,g:w,b:q})}i[m]=g.r,i[m+1]=g.g,i[m+2]=g.b,i[m+3]=o[m+3]}return y}self.onmessage=async n=>{const{type:t,imageData:o,settings:s}=n.data;if(t==="suggest"){try{const{palette:S,numSuggestions:I,preferDistinct:x}=s,k=await et(o,S,I||5,x||!1);self.postMessage({type:"suggestions",suggestions:k})}catch(S){self.postMessage({type:"error",message:S.message})}return}const{targetWidth:h,targetHeight:y,ditherMethod:i,ditherStrength:d,palette:a,resamplingMethod:u,useKmeans:m,kmeansColors:e,brightness:g,contrast:c,saturation:M,preprocessingMethod:l,preprocessingStrength:p,filterTrivialColors:C,colorStats:f,colorMatchAlgorithm:r,preserveDetailThreshold:b}=s,L=r||"oklab",R=b||0;try{let S=a;if(C&&f&&Array.isArray(f)&&f.length>0){const w=new Map(f.map(q=>[q.color,q.percent]));S=a.filter(q=>{const E=w.get(q);return E?E>=.1:!1}),S.length===0&&(S=a)}let I=o;if((g&&g!==0||c&&c!==0||M&&M!==0)&&(I=rt(o,g||0,c||0,M||0)),l&&l!=="none"){const w=p||50;l==="median"?I=ct(I,w):l==="bilateral"?I=at(I,w):l==="kuwahara"&&(I=it(I,w))}let x;u==="lanczos"?x=tt(I,h,y):u==="bilinear"?x=Z(I,h,y):x=Q(I,h,y);let k;if(m&&e>0){const w=x.data,q=[];for(let E=0;E<w.length;E+=4)w[E+3]>128&&q.push([w[E],w[E+1],w[E+2]]);if(q.length>0){const v=(await O(q,Math.min(e,q.length))).centroids.map(P=>({r:Math.round(P[0]),g:Math.round(P[1]),b:Math.round(P[2])}));k=v.map(P=>"#"+((1<<24)+(P.r<<16)+(P.g<<8)+P.b).toString(16).slice(1).toUpperCase());const z=v.map(_),Y=L==="oklab"?v.map(T):null,X=new Map;for(let P=0;P<w.length;P+=4)if(w[P+3]>128){const A={r:w[P],g:w[P+1],b:w[P+2]},{color:H}=G(A,v,z,Y,L,0,X);w[P]=H.r,w[P+1]=H.g,w[P+2]=H.b}}}S&&S.length>0&&ot(x,S,i,d,L,R),self.postMessage({type:"success",imageData:x,generatedPalette:k})}catch(S){self.postMessage({type:"error",message:S.message})}}})();
//# sourceMappingURL=pixelator.worker-DsqtwosJ.js.map
