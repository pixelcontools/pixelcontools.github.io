(function(){"use strict";function W(t){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(t);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:{r:0,g:0,b:0}}function V(t){let n=t.r/255,o=t.g/255,s=t.b/255;return n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,n*=100,o*=100,s*=100,{x:n*.4124+o*.3576+s*.1805,y:n*.2126+o*.7152+s*.0722,z:n*.0193+o*.1192+s*.9505}}function $(t){let n=t.x/95.047,o=t.y/100,s=t.z/108.883;return n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(n-o),b:200*(o-s)}}function _(t){return $(V(t))}function T(t){let n=t.r/255,o=t.g/255,s=t.b/255;n=n>=.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,o=o>=.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>=.04045?Math.pow((s+.055)/1.055,2.4):s/12.92;const g=.4122214708*n+.5363325363*o+.0514459929*s,y=.2119034982*n+.6806995451*o+.1073969566*s,i=.0883024619*n+.2817188376*o+.6299787005*s,l=Math.cbrt(g),a=Math.cbrt(y),u=Math.cbrt(i);return{L:.2104542553*l+.793617785*a-.0040720468*u,a:1.9779984951*l-2.428592205*a+.4505937099*u,b:.0259040371*l+.7827717662*a-.808675766*u}}function B(t,n){const o=t.l-n.l,s=t.a-n.a,g=t.b-n.b;return Math.sqrt(o*o+s*s+g*g)}function D(t,n){const o=t.l-n.l,s=Math.sqrt(t.a*t.a+t.b*t.b),g=Math.sqrt(n.a*n.a+n.b*n.b),y=s-g,i=t.a-n.a,l=t.b-n.b;let a=i*i+l*l-y*y;a<0&&(a=0);const u=Math.sqrt(a),p=1,r=.045,M=.015,c=1,h=1+r*s,d=1+M*s,m=o/(p*c),C=y/h,f=u/d;return Math.sqrt(m*m+C*C+f*f)}function N(t,n){const o=t.l,s=t.a,g=t.b,y=n.l,i=n.a,l=n.b,a=Math.sqrt(s*s+g*g),u=Math.sqrt(i*i+l*l),p=(a+u)/2,r=Math.pow(p,7),M=.5*(1-Math.sqrt(r/(r+6103515625))),c=s*(1+M),h=i*(1+M),d=Math.sqrt(c*c+g*g),m=Math.sqrt(h*h+l*l),C=(d+m)/2;let f=Math.atan2(g,c)*(180/Math.PI);f<0&&(f+=360);let e=Math.atan2(l,h)*(180/Math.PI);e<0&&(e+=360);let b=y-o,L=m-d,v;d*m===0?v=0:Math.abs(e-f)<=180?v=e-f:e-f>180?v=e-f-360:v=e-f+360;const S=2*Math.sqrt(d*m)*Math.sin(v*Math.PI/180/2),I=(o+y)/2;let x;d*m===0?x=f+e:Math.abs(f-e)<=180?x=(f+e)/2:f+e<360?x=(f+e+360)/2:x=(f+e-360)/2;const k=1-.17*Math.cos((x-30)*Math.PI/180)+.24*Math.cos(2*x*Math.PI/180)+.32*Math.cos((3*x+6)*Math.PI/180)-.2*Math.cos((4*x-63)*Math.PI/180),w=1+.015*(I-50)*(I-50)/Math.sqrt(20+(I-50)*(I-50)),q=1+.045*C,E=1+.015*C*k,R=Math.pow(C,7),z=-2*Math.sqrt(R/(R+6103515625))*Math.sin(60*Math.PI/180*Math.exp(-((x-275)/25)*((x-275)/25))),Y=b/w,X=L/q,P=S/E;return Math.sqrt(Y*Y+X*X+P*P+z*X*P)}function j(t,n){const o=t.L-n.L,s=t.a-n.a,g=t.b-n.b;return Math.sqrt(o*o+s*s+g*g)*100}const K=B;function J(t,n,o){const s=t.data,g=new ImageData(n,o),y=g.data,i=t.width/n,l=t.height/o;for(let a=0;a<o;a++)for(let u=0;u<n;u++){const p=Math.floor(u*i),M=(Math.floor(a*l)*t.width+p)*4,c=(a*n+u)*4;y[c]=s[M],y[c+1]=s[M+1],y[c+2]=s[M+2],y[c+3]=s[M+3]}return g}function Q(t,n,o){const s=t.data,g=new ImageData(n,o),y=g.data;if(n<t.width&&o<t.height){const a=t.width/n,u=t.height/o;for(let p=0;p<o;p++)for(let r=0;r<n;r++){const M=r*a,c=p*u,h=a,d=u;let m=0,C=0,f=0,e=0,b=0;const L=Math.floor(M),v=Math.floor(c),S=Math.min(Math.ceil(M+h),t.width),I=Math.min(Math.ceil(c+d),t.height);for(let k=v;k<I;k++)for(let w=L;w<S;w++){const q=Math.min(w+1,M+h)-Math.max(w,M),E=Math.min(k+1,c+d)-Math.max(k,c),R=q*E;if(R<=0)continue;const z=(k*t.width+w)*4;m+=s[z]*R,C+=s[z+1]*R,f+=s[z+2]*R,e+=s[z+3]*R,b+=R}const x=(p*n+r)*4;b>0&&(y[x]=m/b,y[x+1]=C/b,y[x+2]=f/b,y[x+3]=e/b)}return g}const i=(t.width-1)/n,l=(t.height-1)/o;for(let a=0;a<o;a++)for(let u=0;u<n;u++){const p=u*i,r=a*l,M=Math.floor(p),c=Math.floor(r),h=Math.min(M+1,t.width-1),d=Math.min(c+1,t.height-1),m=p-M,C=r-c,f=(a*n+u)*4;for(let e=0;e<4;e++){const b=s[(c*t.width+M)*4+e],L=s[(c*t.width+h)*4+e],v=s[(d*t.width+M)*4+e],S=s[(d*t.width+h)*4+e],I=b*(1-m)+L*m,x=v*(1-m)+S*m,k=I*(1-C)+x*C;y[f+e]=Math.round(k)}}return g}function Z(t,n,o){const s=t.data,g=t.width,y=t.height,i=new Float32Array(n*y*4),l=f=>{if(f=Math.abs(f),f===0)return 1;const e=Math.PI*f;return Math.sin(e)/e},a=(f,e)=>f>-e&&f<e?l(f)*l(f/e):0,u=3,p=g/n,r=p>1?p:1,M=u*r;for(let f=0;f<y;f++)for(let e=0;e<n;e++){const b=(e+.5)*p-.5;let L=0,v=0,S=0,I=0,x=0;const k=Math.floor(b-M+1),w=Math.floor(b+M);for(let E=k;E<=w;E++){if(E<0||E>=g)continue;const R=a((b-E)/r,u);if(R===0)continue;const z=(f*g+E)*4;L+=s[z]*R,v+=s[z+1]*R,S+=s[z+2]*R,I+=s[z+3]*R,x+=R}const q=(f*n+e)*4;x>0&&(i[q]=L/x,i[q+1]=v/x,i[q+2]=S/x,i[q+3]=I/x)}const c=new ImageData(n,o),h=c.data,d=y/o,m=d>1?d:1,C=u*m;for(let f=0;f<n;f++)for(let e=0;e<o;e++){const b=(e+.5)*d-.5;let L=0,v=0,S=0,I=0,x=0;const k=Math.floor(b-C+1),w=Math.floor(b+C);for(let E=k;E<=w;E++){if(E<0||E>=y)continue;const R=a((b-E)/m,u);if(R===0)continue;const z=(E*n+f)*4;L+=i[z]*R,v+=i[z+1]*R,S+=i[z+2]*R,I+=i[z+3]*R,x+=R}const q=(e*n+f)*4;x>0&&(h[q]=Math.max(0,Math.min(255,L/x)),h[q+1]=Math.max(0,Math.min(255,v/x)),h[q+2]=Math.max(0,Math.min(255,S/x)),h[q+3]=Math.max(0,Math.min(255,I/x)))}return c}const U={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},tt={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function G(t,n,o,s,g,y,i){const l=Math.max(0,Math.min(255,Math.round(t.r))),a=Math.max(0,Math.min(255,Math.round(t.g))),u=Math.max(0,Math.min(255,Math.round(t.b))),p=l<<16|a<<8|u;if(i){const d=i.get(p);if(d)return d}let r=1/0,M=n[0];const c={r:l,g:a,b:u};if(g==="oklab"){const d=T(c);for(let m=0;m<n.length;m++){const C=j(d,s[m]);C<r&&(r=C,M=n[m])}}else{const d=_(c),m=g==="ciede2000"?N:g==="cie94"?D:B;for(let C=0;C<n.length;C++){const f=m(d,o[C]);f<r&&(r=f,M=n[C])}}let h;return y>0&&r<=y?h={color:c,dist:0}:h={color:M,dist:r},i&&i.set(p,h),h}function nt(t,n,o,s,g="oklab",y=0){const i=t.data,l=t.width,a=t.height,u=n.map(W),p=u.map(_),r=g==="oklab"?u.map(T):null,M=new Map,c=s/100;if(o in U){const h=U[o],d=h.matrix,m=h.size,C=h.divisor,f=64;for(let e=0;e<a;e++)for(let b=0;b<l;b++){const L=(e*l+b)*4;if(i[L+3]<128){i[L+3]=0;continue}const v=b%m,S=e%m,x=(d[S][v]/C-.5)*f*c,k={r:Math.max(0,Math.min(255,i[L]+x)),g:Math.max(0,Math.min(255,i[L+1]+x)),b:Math.max(0,Math.min(255,i[L+2]+x))},{color:w}=G(k,u,p,r,g,y,M);i[L]=w.r,i[L+1]=w.g,i[L+2]=w.b,i[L+3]=255}}else{const h=new Float32Array(i),d=tt[o];for(let m=0;m<a;m++)for(let C=0;C<l;C++){const f=(m*l+C)*4;if(h[f+3]<128){i[f+3]=0;continue}const e={r:h[f],g:h[f+1],b:h[f+2]},{color:b}=G(e,u,p,r,g,y,M);if(i[f]=b.r,i[f+1]=b.g,i[f+2]=b.b,i[f+3]=255,o==="none"||!d)continue;const L={r:(e.r-b.r)*c,g:(e.g-b.g)*c,b:(e.b-b.b)*c};for(const v of d){const S=C+v.dx,I=m+v.dy;if(S>=0&&S<l&&I>=0&&I<a){const x=(I*l+S)*4;if(h[x+3]<128)continue;h[x]+=L.r*v.f,h[x+1]+=L.g*v.f,h[x+2]+=L.b*v.f}}}}}function O(t,n,o=20){return new Promise(s=>{if(n>t.length&&(n=t.length),n===0){s({centroids:[],assignments:[]});return}let g=[];const y=[...t];for(let l=0;l<n;l++){const a=Math.floor(Math.random()*y.length);g.push(y.splice(a,1)[0])}let i=new Array(t.length);for(let l=0;l<o;l++){for(let r=0;r<t.length;r++){let M=1/0,c=-1;for(let h=0;h<n;h++){const d=(t[r][0]-g[h][0])**2+(t[r][1]-g[h][1])**2+(t[r][2]-g[h][2])**2;d<M&&(M=d,c=h)}i[r]=c}const a=Array.from({length:n},()=>[0,0,0]),u=new Array(n).fill(0);for(let r=0;r<t.length;r++){const M=i[r];a[M][0]+=t[r][0],a[M][1]+=t[r][1],a[M][2]+=t[r][2],u[M]++}for(let r=0;r<n;r++)u[r]>0?(a[r][0]/=u[r],a[r][1]/=u[r],a[r][2]/=u[r]):a[r]=t[Math.floor(Math.random()*t.length)];let p=!1;for(let r=0;r<n;r++)if(g[r][0]!==a[r][0]||g[r][1]!==a[r][1]||g[r][2]!==a[r][2]){p=!0;break}if(g=a,!p)break}s({centroids:g,assignments:i})})}function ot(t){const n=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${n(t.r)}${n(t.g)}${n(t.b)}`.toUpperCase()}async function st(t,n,o,s=!1){if(n.length===0)return[];const y=n.map(W).map(_),i=t.data,l=[],a=i.length/4,p=Math.ceil(a/4096)*4;for(let e=0;e<i.length;e+=p)i[e+3]>128&&l.push([i[e],i[e+1],i[e+2]]);if(l.length===0)return[];let r=Math.min(128,l.length);s&&(r=Math.min(256,l.length));const M=await O(l,r),c=M.centroids,h=M.assignments,d=new Array(c.length).fill(0);for(const e of h)d[e]++;const m=[];for(let e=0;e<c.length;e++){const b=c[e],L=d[e];if(L===0)continue;const v={r:Math.round(b[0]),g:Math.round(b[1]),b:Math.round(b[2])},S=_(v);let I=1/0;for(const k of y){const w=K(S,k);w<I&&(I=w)}const x=I*L;m.push({hex:ot(v),rgb:v,error:I,count:L,totalError:x})}if(m.sort((e,b)=>b.totalError-e.totalError),!s)return m.slice(0,o).map(e=>e.hex);const C=[],f=30;for(const e of m){if(C.length>=o)break;if(C.length===0)C.push(e);else{let b=!0;const L=_(e.rgb);for(const v of C){const S=_(v.rgb);if(K(L,S)<f){b=!1;break}}b&&C.push(e)}}return C.map(e=>e.hex)}function et(t,n,o,s){const g=t.data,y=t.width,i=t.height,l=new ImageData(new Uint8ClampedArray(g),y,i),a=l.data,u=259*(o+255)/(255*(259-o));for(let p=0;p<a.length;p+=4){let r=a[p],M=a[p+1],c=a[p+2];if(r+=n,M+=n,c+=n,r=u*(r-128)+128,M=u*(M-128)+128,c=u*(c-128)+128,s!==0){const h=.2989*r+.587*M+.114*c,d=1+s/100;r=h+(r-h)*d,M=h+(M-h)*d,c=h+(c-h)*d}a[p]=Math.max(0,Math.min(255,r)),a[p+1]=Math.max(0,Math.min(255,M)),a[p+2]=Math.max(0,Math.min(255,c))}return l}function rt(t,n){const o=t.data,s=t.width,g=t.height,y=new ImageData(new Uint8ClampedArray(o),s,g),i=y.data,l=Math.max(1,Math.floor(n/100*10));for(let a=0;a<g;a++)for(let u=0;u<s;u++){const p=(a*s+u)*4,r=[],M=[],c=[];for(let d=-l;d<=l;d++)for(let m=-l;m<=l;m++){const C=Math.min(g-1,Math.max(0,a+d)),f=Math.min(s-1,Math.max(0,u+m)),e=(C*s+f)*4;r.push(o[e]),M.push(o[e+1]),c.push(o[e+2])}r.sort((d,m)=>d-m),M.sort((d,m)=>d-m),c.sort((d,m)=>d-m);const h=Math.floor(r.length/2);i[p]=r[h],i[p+1]=M[h],i[p+2]=c[h],i[p+3]=o[p+3]}return y}function at(t,n){const o=t.data,s=t.width,g=t.height,y=new ImageData(new Uint8ClampedArray(o),s,g),i=y.data,l=Math.max(2,Math.floor(n/100*12)),a=l/2,u=30+n*1.5,p=[];for(let c=-l;c<=l;c++)p.push(Math.exp(-(c*c)/(2*a*a)));const r=new Float32Array(256*3),M=-1/(2*u*u);for(let c=0;c<r.length;c++)r[c]=Math.exp(c*c*M);for(let c=0;c<g;c++)for(let h=0;h<s;h++){const d=(c*s+h)*4,m=o[d],C=o[d+1],f=o[d+2];let e=0,b=0,L=0,v=0;for(let S=-l;S<=l;S++){const I=c+S;if(I<0||I>=g)continue;const x=p[S+l];for(let k=-l;k<=l;k++){const w=h+k;if(w<0||w>=s)continue;const q=(I*s+w)*4,E=o[q],R=o[q+1],z=o[q+2],Y=Math.abs(E-m)+Math.abs(R-C)+Math.abs(z-f),X=x*p[k+l]*Math.exp(Y*Y*M);e+=E*X,b+=R*X,L+=z*X,v+=X}}i[d]=e/v,i[d+1]=b/v,i[d+2]=L/v,i[d+3]=o[d+3]}return y}function ct(t,n){const o=t.data,s=t.width,g=t.height,y=new ImageData(new Uint8ClampedArray(o),s,g),i=y.data,l=Math.max(2,Math.floor(n/100*14));for(let a=0;a<g;a++)for(let u=0;u<s;u++){const p=(a*s+u)*4;if(o[p+3]===0)continue;let r=1/0,M={r:o[p],g:o[p+1],b:o[p+2]};const c=[[-l,0,-l,0],[0,l,-l,0],[-l,0,0,l],[0,l,0,l]];for(let h=0;h<4;h++){const[d,m,C,f]=c[h];let e=0,b=0,L=0,v=0,S=0,I=0,x=0;for(let R=C;R<=f;R++){const z=a+R;if(!(z<0||z>=g))for(let Y=d;Y<=m;Y++){const X=u+Y;if(X<0||X>=s)continue;const P=(z*s+X)*4,A=o[P],H=o[P+1],F=o[P+2];e+=A,b+=H,L+=F,v+=A*A,S+=H*H,I+=F*F,x++}}if(x===0)continue;const k=e/x,w=b/x,q=L/x,E=(v+S+I)/x-(k*k+w*w+q*q);E<r&&(r=E,M={r:k,g:w,b:q})}i[p]=M.r,i[p+1]=M.g,i[p+2]=M.b,i[p+3]=o[p+3]}return y}self.onmessage=async t=>{const{type:n,imageData:o,settings:s}=t.data;if(n==="suggest"){try{const{palette:S,numSuggestions:I,preferDistinct:x}=s,k=await st(o,S,I||5,x||!1);self.postMessage({type:"suggestions",suggestions:k})}catch(S){self.postMessage({type:"error",message:S.message})}return}const{targetWidth:g,targetHeight:y,ditherMethod:i,ditherStrength:l,palette:a,resamplingMethod:u,useKmeans:p,kmeansColors:r,brightness:M,contrast:c,saturation:h,preprocessingMethod:d,preprocessingStrength:m,filterTrivialColors:C,colorStats:f,colorMatchAlgorithm:e,preserveDetailThreshold:b}=s,L=e||"oklab",v=b||0;try{let S=a;if(C&&f&&Array.isArray(f)&&f.length>0){const w=new Map(f.map(q=>[q.color,q.percent]));S=a.filter(q=>{const E=w.get(q);return E?E>=.1:!1}),S.length===0&&(S=a)}let I=o;if((M&&M!==0||c&&c!==0||h&&h!==0)&&(I=et(o,M||0,c||0,h||0)),d&&d!=="none"){const w=m||50;d==="median"?I=rt(I,w):d==="bilateral"?I=at(I,w):d==="kuwahara"&&(I=ct(I,w))}let x;u==="lanczos"?x=Z(I,g,y):u==="bilinear"?x=Q(I,g,y):x=J(I,g,y);let k;if(p&&r>0){const w=x.data,q=[];for(let E=0;E<w.length;E+=4)w[E+3]>128&&q.push([w[E],w[E+1],w[E+2]]);if(q.length>0){const R=(await O(q,Math.min(r,q.length))).centroids.map(P=>({r:Math.round(P[0]),g:Math.round(P[1]),b:Math.round(P[2])}));k=R.map(P=>"#"+((1<<24)+(P.r<<16)+(P.g<<8)+P.b).toString(16).slice(1).toUpperCase());const z=R.map(_),Y=L==="oklab"?R.map(T):null,X=new Map;for(let P=0;P<w.length;P+=4)if(w[P+3]>128){const A={r:w[P],g:w[P+1],b:w[P+2]},{color:H}=G(A,R,z,Y,L,0,X);w[P]=H.r,w[P+1]=H.g,w[P+2]=H.b}}}S&&S.length>0&&nt(x,S,i,l,L,v),self.postMessage({type:"success",imageData:x,generatedPalette:k})}catch(S){self.postMessage({type:"error",message:S.message})}}})();
//# sourceMappingURL=pixelator.worker-qXV9h1d8.js.map
