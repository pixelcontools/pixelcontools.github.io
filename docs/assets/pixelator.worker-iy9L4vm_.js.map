{"version":3,"file":"pixelator.worker-iy9L4vm_.js","sources":["../src/workers/pixelator.worker.ts"],"sourcesContent":["// src/workers/pixelator.worker.ts\r\n\r\nconst GEOPIXELS_PALETTE = [\r\n  \"#FFFFFF\",\"#F4F59F\",\"#FFCA3A\",\"#FF9F1C\",\"#FF595E\",\"#E71D36\",\"#F3BBC2\",\"#FF85A1\",\"#BD637D\",\"#CDB4DB\",\"#6A4C93\",\"#4D194D\",\"#A8D0DC\",\"#2EC4B6\",\"#1A535C\",\"#6D9DCD\",\"#1982C4\",\"#A1C181\",\"#8AC926\",\"#A0A0A0\",\"#6B4226\",\"#505050\",\"#CFD078\",\"#145A7A\",\"#8B1D24\",\"#C07F7A\",\"#C49A6C\",\"#5B7B1C\",\"#000000\"\r\n];\r\n\r\nconst WPLACE_PALETTE = [\r\n  \"#000000\",\"#3c3c3c\",\"#787878\",\"#aaaaaa\",\"#d2d2d2\",\"#ffffff\",\"#600018\",\"#a50e1e\",\"#ed1c24\",\"#fa8072\",\"#e45c1a\",\"#ff7f27\",\"#f6aa09\",\"#f9dd3b\",\"#fffabc\",\"#9c8431\",\"#c5ad31\",\"#e8d45f\",\"#4a6b3a\",\"#5a944a\",\"#84c573\",\"#0eb968\",\"#13e67b\",\"#87ff5e\",\"#0c816e\",\"#10aea6\",\"#13e1be\",\"#0f799f\",\"#60f7f2\",\"#bbfaf2\",\"#28509e\",\"#4093e4\",\"#7dc7ff\",\"#4d31b8\",\"#6b50f6\",\"#99b1fb\",\"#4a4284\",\"#7a71c4\",\"#b5aef1\",\"#780c99\",\"#aa38b9\",\"#e09ff9\",\"#cb007a\",\"#ec1f80\",\"#f38da9\",\"#9b5249\",\"#d18078\",\"#fab6a4\",\"#684634\",\"#95682a\",\"#dba463\",\"#7b6352\",\"#9c846b\",\"#d6b594\",\"#d18051\",\"#f8b277\",\"#ffc5a5\",\"#6d643f\",\"#948c6b\",\"#cdc59e\",\"#333941\",\"#6d758d\",\"#b3b9d1\"\r\n];\r\n\r\nconst WPLACE_FREE_PALETTE = [\r\n  \"#000000\",\"#3c3c3c\",\"#787878\",\"#d2d2d2\",\"#ffffff\",\"#600018\",\"#ed1c24\",\"#ff7f27\",\"#f6aa09\",\"#f9dd3b\",\"#fffabc\",\"#0eb968\",\"#13e67b\",\"#87ff5e\",\"#0c816e\",\"#10aea6\",\"#13e1be\",\"#60f7f2\",\"#28509e\",\"#4093e4\",\"#6b50f6\",\"#99b1fb\",\"#780c99\",\"#aa38b9\",\"#e09ff9\",\"#cb007a\",\"#ec1f80\",\"#f38da9\",\"#684634\",\"#95682a\",\"#f8b277\"\r\n];\r\n\r\ntype ColorMatchAlgorithm = 'oklab' | 'ciede2000' | 'cie94' | 'cie76' | 'redmean';\r\n\r\ninterface RGB { r: number; g: number; b: number; }\r\ninterface LAB { l: number; a: number; b: number; }\r\ninterface OKLabColor { L: number; a: number; b: number; }\r\n\r\n// --- Color Conversion & Distance ---\r\n\r\nfunction hexToRgb(hex: string): RGB {\r\n  const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})/i.exec(hex);\r\n  return result ? {\r\n    r: parseInt(result[1], 16),\r\n    g: parseInt(result[2], 16),\r\n    b: parseInt(result[3], 16)\r\n  } : { r: 0, g: 0, b: 0 };\r\n}\r\n\r\nfunction rgbToXyz(c: RGB) {\r\n  let r = c.r / 255;\r\n  let g = c.g / 255;\r\n  let b = c.b / 255;\r\n\r\n  r = r > 0.04045 ? Math.pow(((r + 0.055) / 1.055), 2.4) : r / 12.92;\r\n  g = g > 0.04045 ? Math.pow(((g + 0.055) / 1.055), 2.4) : g / 12.92;\r\n  b = b > 0.04045 ? Math.pow(((b + 0.055) / 1.055), 2.4) : b / 12.92;\r\n\r\n  r *= 100; g *= 100; b *= 100;\r\n\r\n  return {\r\n    x: r * 0.4124 + g * 0.3576 + b * 0.1805,\r\n    y: r * 0.2126 + g * 0.7152 + b * 0.0722,\r\n    z: r * 0.0193 + g * 0.1192 + b * 0.9505\r\n  };\r\n}\r\n\r\nfunction xyzToLab(c: { x: number, y: number, z: number }): LAB {\r\n  let x = c.x / 95.047;\r\n  let y = c.y / 100.000;\r\n  let z = c.z / 108.883;\r\n\r\n  x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + (16 / 116);\r\n  y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + (16 / 116);\r\n  z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + (16 / 116);\r\n\r\n  return {\r\n    l: (116 * y) - 16,\r\n    a: 500 * (x - y),\r\n    b: 200 * (y - z)\r\n  };\r\n}\r\n\r\nfunction rgbToLab(c: RGB): LAB {\r\n  return xyzToLab(rgbToXyz(c));\r\n}\r\n\r\n// --- OKLab Color Space ---\r\n\r\nfunction rgbToOklab(c: RGB): OKLabColor {\r\n  // sRGB → linear sRGB\r\n  let r = c.r / 255;\r\n  let g = c.g / 255;\r\n  let b = c.b / 255;\r\n  r = r >= 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;\r\n  g = g >= 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;\r\n  b = b >= 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;\r\n\r\n  // linear sRGB → LMS (using Oklab M1 matrix)\r\n  const l_ = 0.4122214708 * r + 0.5363325363 * g + 0.0514459929 * b;\r\n  const m_ = 0.2119034982 * r + 0.6806995451 * g + 0.1073969566 * b;\r\n  const s_ = 0.0883024619 * r + 0.2817188376 * g + 0.6299787005 * b;\r\n\r\n  // LMS → LMS^(1/3)\r\n  const l3 = Math.cbrt(l_);\r\n  const m3 = Math.cbrt(m_);\r\n  const s3 = Math.cbrt(s_);\r\n\r\n  // LMS^(1/3) → OKLab\r\n  return {\r\n    L: 0.2104542553 * l3 + 0.7936177850 * m3 - 0.0040720468 * s3,\r\n    a: 1.9779984951 * l3 - 2.4285922050 * m3 + 0.4505937099 * s3,\r\n    b: 0.0259040371 * l3 + 0.7827717662 * m3 - 0.8086757660 * s3,\r\n  };\r\n}\r\n\r\n// --- Color Distance Functions ---\r\n\r\n/** CIE76: simple Euclidean in CIELAB */\r\nfunction deltaE_CIE76(labA: LAB, labB: LAB): number {\r\n  const dL = labA.l - labB.l;\r\n  const da = labA.a - labB.a;\r\n  const db = labA.b - labB.b;\r\n  return Math.sqrt(dL * dL + da * da + db * db);\r\n}\r\n\r\n/** Redmean: fast weighted RGB distance (no color space conversion) */\r\nfunction deltaE_Redmean(a: RGB, b: RGB): number {\r\n  const rMean = (a.r + b.r) / 2;\r\n  const dr = a.r - b.r;\r\n  const dg = a.g - b.g;\r\n  const db = a.b - b.b;\r\n  return Math.sqrt((2 + rMean / 256) * dr * dr + 4 * dg * dg + (2 + (255 - rMean) / 256) * db * db);\r\n}\r\n\r\n/** CIE94: weighted Euclidean in CIELAB (graphics arts) */\r\nfunction deltaE_CIE94(labA: LAB, labB: LAB): number {\r\n  const dL = labA.l - labB.l;\r\n  const C1 = Math.sqrt(labA.a * labA.a + labA.b * labA.b);\r\n  const C2 = Math.sqrt(labB.a * labB.a + labB.b * labB.b);\r\n  const dC = C1 - C2;\r\n  const da = labA.a - labB.a;\r\n  const db = labA.b - labB.b;\r\n  let dH2 = da * da + db * db - dC * dC;\r\n  if (dH2 < 0) dH2 = 0;\r\n  const dH = Math.sqrt(dH2);\r\n  // Graphic arts application constants\r\n  const kL = 1, K1 = 0.045, K2 = 0.015;\r\n  const SL = 1;\r\n  const SC = 1 + K1 * C1;\r\n  const SH = 1 + K2 * C1;\r\n  const t1 = dL / (kL * SL);\r\n  const t2 = dC / SC;\r\n  const t3 = dH / SH;\r\n  return Math.sqrt(t1 * t1 + t2 * t2 + t3 * t3);\r\n}\r\n\r\n/** CIEDE2000: the gold standard perceptual color difference */\r\nfunction deltaE_CIEDE2000(labA: LAB, labB: LAB): number {\r\n  const L1 = labA.l, a1 = labA.a, b1 = labA.b;\r\n  const L2 = labB.l, a2 = labB.a, b2 = labB.b;\r\n\r\n  const C1 = Math.sqrt(a1 * a1 + b1 * b1);\r\n  const C2 = Math.sqrt(a2 * a2 + b2 * b2);\r\n  const avgC = (C1 + C2) / 2;\r\n\r\n  const avgC7 = Math.pow(avgC, 7);\r\n  const G = 0.5 * (1 - Math.sqrt(avgC7 / (avgC7 + 6103515625))); // 25^7\r\n  const a1p = a1 * (1 + G);\r\n  const a2p = a2 * (1 + G);\r\n  const C1p = Math.sqrt(a1p * a1p + b1 * b1);\r\n  const C2p = Math.sqrt(a2p * a2p + b2 * b2);\r\n  const avgCp = (C1p + C2p) / 2;\r\n\r\n  let h1p = Math.atan2(b1, a1p) * (180 / Math.PI); if (h1p < 0) h1p += 360;\r\n  let h2p = Math.atan2(b2, a2p) * (180 / Math.PI); if (h2p < 0) h2p += 360;\r\n\r\n  let dLp = L2 - L1;\r\n  let dCp = C2p - C1p;\r\n  let dhp: number;\r\n  if (C1p * C2p === 0) { dhp = 0; }\r\n  else if (Math.abs(h2p - h1p) <= 180) { dhp = h2p - h1p; }\r\n  else if (h2p - h1p > 180) { dhp = h2p - h1p - 360; }\r\n  else { dhp = h2p - h1p + 360; }\r\n  const dHp = 2 * Math.sqrt(C1p * C2p) * Math.sin((dhp * Math.PI / 180) / 2);\r\n\r\n  const avgLp = (L1 + L2) / 2;\r\n  let avgHp: number;\r\n  if (C1p * C2p === 0) { avgHp = h1p + h2p; }\r\n  else if (Math.abs(h1p - h2p) <= 180) { avgHp = (h1p + h2p) / 2; }\r\n  else if (h1p + h2p < 360) { avgHp = (h1p + h2p + 360) / 2; }\r\n  else { avgHp = (h1p + h2p - 360) / 2; }\r\n\r\n  const T = 1\r\n    - 0.17 * Math.cos((avgHp - 30) * Math.PI / 180)\r\n    + 0.24 * Math.cos((2 * avgHp) * Math.PI / 180)\r\n    + 0.32 * Math.cos((3 * avgHp + 6) * Math.PI / 180)\r\n    - 0.20 * Math.cos((4 * avgHp - 63) * Math.PI / 180);\r\n\r\n  const SL = 1 + (0.015 * (avgLp - 50) * (avgLp - 50)) / Math.sqrt(20 + (avgLp - 50) * (avgLp - 50));\r\n  const SC = 1 + 0.045 * avgCp;\r\n  const SH = 1 + 0.015 * avgCp * T;\r\n\r\n  const avgCp7 = Math.pow(avgCp, 7);\r\n  const RT = -2 * Math.sqrt(avgCp7 / (avgCp7 + 6103515625))\r\n    * Math.sin(60 * Math.PI / 180 * Math.exp(-((avgHp - 275) / 25) * ((avgHp - 275) / 25)));\r\n\r\n  const tL = dLp / SL;\r\n  const tC = dCp / SC;\r\n  const tH = dHp / SH;\r\n\r\n  return Math.sqrt(tL * tL + tC * tC + tH * tH + RT * tC * tH);\r\n}\r\n\r\n/** OKLab: Euclidean distance in OKLab space (modern perceptual) */\r\nfunction deltaE_OKLab(a: OKLabColor, b: OKLabColor): number {\r\n  const dL = a.L - b.L;\r\n  const da = a.a - b.a;\r\n  const db = a.b - b.b;\r\n  // Scale by 100 to make values comparable to CIELAB ΔE range\r\n  return Math.sqrt(dL * dL + da * da + db * db) * 100;\r\n}\r\n\r\n// Alias for backward compat\r\nconst getDeltaE = deltaE_CIE76;\r\n\r\n// --- Resizing ---\r\n\r\nfunction resampleNearest(srcData: ImageData, width: number, height: number): ImageData {\r\n  const src = srcData.data;\r\n  const dest = new ImageData(width, height);\r\n  const destData = dest.data;\r\n  const xRatio = srcData.width / width;\r\n  const yRatio = srcData.height / height;\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const srcX = Math.floor(x * xRatio);\r\n      const srcY = Math.floor(y * yRatio);\r\n      const srcIdx = (srcY * srcData.width + srcX) * 4;\r\n      const destIdx = (y * width + x) * 4;\r\n      \r\n      destData[destIdx] = src[srcIdx];\r\n      destData[destIdx + 1] = src[srcIdx + 1];\r\n      destData[destIdx + 2] = src[srcIdx + 2];\r\n      destData[destIdx + 3] = src[srcIdx + 3];\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\nfunction resampleBilinear(srcData: ImageData, width: number, height: number): ImageData {\r\n  const src = srcData.data;\r\n  const dest = new ImageData(width, height);\r\n  const destData = dest.data;\r\n  \r\n  // If downscaling significantly, use area averaging (box sampling) for smoother results\r\n  if (width < srcData.width && height < srcData.height) {\r\n      const xRatio = srcData.width / width;\r\n      const yRatio = srcData.height / height;\r\n      \r\n      for (let y = 0; y < height; y++) {\r\n          for (let x = 0; x < width; x++) {\r\n              const srcX = x * xRatio;\r\n              const srcY = y * yRatio;\r\n              const srcW = xRatio;\r\n              const srcH = yRatio;\r\n              \r\n              let r = 0, g = 0, b = 0, a = 0, totalWeight = 0;\r\n              \r\n              const startX = Math.floor(srcX);\r\n              const startY = Math.floor(srcY);\r\n              const endX = Math.min(Math.ceil(srcX + srcW), srcData.width);\r\n              const endY = Math.min(Math.ceil(srcY + srcH), srcData.height);\r\n              \r\n              for (let sy = startY; sy < endY; sy++) {\r\n                  for (let sx = startX; sx < endX; sx++) {\r\n                      // Calculate weight based on overlap area\r\n                      const weightX = Math.min(sx + 1, srcX + srcW) - Math.max(sx, srcX);\r\n                      const weightY = Math.min(sy + 1, srcY + srcH) - Math.max(sy, srcY);\r\n                      const weight = weightX * weightY;\r\n                      \r\n                      if (weight <= 0) continue;\r\n                      \r\n                      const srcIdx = (sy * srcData.width + sx) * 4;\r\n                      r += src[srcIdx] * weight;\r\n                      g += src[srcIdx + 1] * weight;\r\n                      b += src[srcIdx + 2] * weight;\r\n                      a += src[srcIdx + 3] * weight;\r\n                      totalWeight += weight;\r\n                  }\r\n              }\r\n              \r\n              const destIdx = (y * width + x) * 4;\r\n              if (totalWeight > 0) {\r\n                  destData[destIdx] = r / totalWeight;\r\n                  destData[destIdx + 1] = g / totalWeight;\r\n                  destData[destIdx + 2] = b / totalWeight;\r\n                  destData[destIdx + 3] = a / totalWeight;\r\n              }\r\n          }\r\n      }\r\n      return dest;\r\n  }\r\n\r\n  // Standard Bilinear for upscaling or mixed scaling\r\n  const xRatio = (srcData.width - 1) / width;\r\n  const yRatio = (srcData.height - 1) / height;\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const srcX = x * xRatio;\r\n      const srcY = y * yRatio;\r\n      \r\n      const x1 = Math.floor(srcX);\r\n      const y1 = Math.floor(srcY);\r\n      const x2 = Math.min(x1 + 1, srcData.width - 1);\r\n      const y2 = Math.min(y1 + 1, srcData.height - 1);\r\n      \r\n      const dx = srcX - x1;\r\n      const dy = srcY - y1;\r\n      \r\n      const destIdx = (y * width + x) * 4;\r\n      \r\n      for (let c = 0; c < 4; c++) {\r\n        const v1 = src[(y1 * srcData.width + x1) * 4 + c];\r\n        const v2 = src[(y1 * srcData.width + x2) * 4 + c];\r\n        const v3 = src[(y2 * srcData.width + x1) * 4 + c];\r\n        const v4 = src[(y2 * srcData.width + x2) * 4 + c];\r\n        \r\n        const top = v1 * (1 - dx) + v2 * dx;\r\n        const bottom = v3 * (1 - dx) + v4 * dx;\r\n        const value = top * (1 - dy) + bottom * dy;\r\n        \r\n        destData[destIdx + c] = Math.round(value);\r\n      }\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\nfunction resampleLanczos(imageData: ImageData, width: number, height: number): ImageData {\r\n    const srcData = imageData.data;\r\n    const srcWidth = imageData.width;\r\n    const srcHeight = imageData.height;\r\n    \r\n    // 1. Horizontal Pass (Resize Width)\r\n    // We create a temporary buffer with target width but original height\r\n    // We use Float32Array for intermediate precision\r\n    const tempBuffer = new Float32Array(width * srcHeight * 4);\r\n    \r\n    const sinc = (x: number) => {\r\n        x = Math.abs(x);\r\n        if (x === 0) return 1;\r\n        const piX = Math.PI * x;\r\n        return Math.sin(piX) / piX;\r\n    };\r\n\r\n    const lanczosKernel = (x: number, a: number) => {\r\n        if (x > -a && x < a) {\r\n            return sinc(x) * sinc(x / a);\r\n        }\r\n        return 0;\r\n    };\r\n\r\n    const a = 3;\r\n    const ratioX = srcWidth / width;\r\n    const scaleX = ratioX > 1 ? ratioX : 1;\r\n    const radiusX = a * scaleX;\r\n\r\n    for (let y = 0; y < srcHeight; y++) {\r\n        for (let x = 0; x < width; x++) {\r\n            const sx = (x + 0.5) * ratioX - 0.5;\r\n            \r\n            let r = 0, g = 0, b = 0, a_val = 0, totalWeight = 0;\r\n            \r\n            const startX = Math.floor(sx - radiusX + 1);\r\n            const endX = Math.floor(sx + radiusX);\r\n            \r\n            for (let i = startX; i <= endX; i++) {\r\n                if (i < 0 || i >= srcWidth) continue;\r\n                \r\n                const weight = lanczosKernel((sx - i) / scaleX, a);\r\n                if (weight === 0) continue;\r\n                \r\n                const srcIdx = (y * srcWidth + i) * 4;\r\n                r += srcData[srcIdx] * weight;\r\n                g += srcData[srcIdx + 1] * weight;\r\n                b += srcData[srcIdx + 2] * weight;\r\n                a_val += srcData[srcIdx + 3] * weight;\r\n                totalWeight += weight;\r\n            }\r\n            \r\n            const destIdx = (y * width + x) * 4;\r\n            if (totalWeight > 0) {\r\n                tempBuffer[destIdx] = r / totalWeight;\r\n                tempBuffer[destIdx + 1] = g / totalWeight;\r\n                tempBuffer[destIdx + 2] = b / totalWeight;\r\n                tempBuffer[destIdx + 3] = a_val / totalWeight;\r\n            }\r\n        }\r\n    }\r\n\r\n    // 2. Vertical Pass (Resize Height)\r\n    // Resize from temp buffer (width x srcHeight) to final (width x height)\r\n    const destImageData = new ImageData(width, height);\r\n    const destData = destImageData.data;\r\n    \r\n    const ratioY = srcHeight / height;\r\n    const scaleY = ratioY > 1 ? ratioY : 1;\r\n    const radiusY = a * scaleY;\r\n\r\n    for (let x = 0; x < width; x++) {\r\n        for (let y = 0; y < height; y++) {\r\n            const sy = (y + 0.5) * ratioY - 0.5;\r\n            \r\n            let r = 0, g = 0, b = 0, a_val = 0, totalWeight = 0;\r\n            \r\n            const startY = Math.floor(sy - radiusY + 1);\r\n            const endY = Math.floor(sy + radiusY);\r\n            \r\n            for (let i = startY; i <= endY; i++) {\r\n                if (i < 0 || i >= srcHeight) continue;\r\n                \r\n                const weight = lanczosKernel((sy - i) / scaleY, a);\r\n                if (weight === 0) continue;\r\n                \r\n                const srcIdx = (i * width + x) * 4;\r\n                r += tempBuffer[srcIdx] * weight;\r\n                g += tempBuffer[srcIdx + 1] * weight;\r\n                b += tempBuffer[srcIdx + 2] * weight;\r\n                a_val += tempBuffer[srcIdx + 3] * weight;\r\n                totalWeight += weight;\r\n            }\r\n            \r\n            const destIdx = (y * width + x) * 4;\r\n            if (totalWeight > 0) {\r\n                // Clamp values to 0-255 for final output\r\n                destData[destIdx] = Math.max(0, Math.min(255, r / totalWeight));\r\n                destData[destIdx + 1] = Math.max(0, Math.min(255, g / totalWeight));\r\n                destData[destIdx + 2] = Math.max(0, Math.min(255, b / totalWeight));\r\n                destData[destIdx + 3] = Math.max(0, Math.min(255, a_val / totalWeight));\r\n            }\r\n        }\r\n    }\r\n\r\n    return destImageData;\r\n}\r\n\r\n// --- Dithering ---\r\n\r\nconst ditherMatrices: Record<string, { matrix: number[][], size: number, divisor: number }> = {\r\n    'bayer-4x4': {\r\n        matrix: [[0, 8, 2, 10], [12, 4, 14, 6], [3, 11, 1, 9], [15, 7, 13, 5]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'bayer-8x8': {\r\n        matrix: [\r\n            [0, 32, 8, 40, 2, 34, 10, 42], [48, 16, 56, 24, 50, 18, 58, 26],\r\n            [12, 44, 4, 36, 14, 46, 6, 38], [60, 28, 52, 20, 62, 30, 54, 22],\r\n            [3, 35, 11, 43, 1, 33, 9, 41], [51, 19, 59, 27, 49, 17, 57, 25],\r\n            [15, 47, 7, 39, 13, 45, 5, 37], [63, 31, 55, 23, 61, 29, 53, 21]\r\n        ],\r\n        size: 8, divisor: 64\r\n    },\r\n    'halftone-dot': {\r\n        matrix: [[12, 5, 6, 13], [4, 0, 1, 7], [8, 2, 3, 11], [14, 9, 10, 15]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'diagonal-line': {\r\n        matrix: [[15, 7, 3, 7], [7, 3, 7, 15], [3, 7, 15, 7], [7, 15, 7, 3]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'cross-hatch': {\r\n        matrix: [[0, 8, 0, 8], [8, 15, 8, 15], [0, 8, 0, 8], [8, 15, 8, 15]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'grid': {\r\n        matrix: [[0, 0, 0, 0], [0, 15, 15, 0], [0, 15, 15, 0], [0, 0, 0, 0]],\r\n        size: 4, divisor: 16\r\n    }\r\n};\r\n\r\nconst errorKernels: Record<string, { dx: number, dy: number, f: number }[]> = {\r\n    'floyd-steinberg': [\r\n        { dx: 1, dy: 0, f: 7 / 16 }, { dx: -1, dy: 1, f: 3 / 16 }, { dx: 0, dy: 1, f: 5 / 16 }, { dx: 1, dy: 1, f: 1 / 16 }\r\n    ],\r\n    'burkes': [\r\n        { dx: 1, dy: 0, f: 8 / 32 }, { dx: 2, dy: 0, f: 4 / 32 }, { dx: -2, dy: 1, f: 2 / 32 }, { dx: -1, dy: 1, f: 4 / 32 },\r\n        { dx: 0, dy: 1, f: 8 / 32 }, { dx: 1, dy: 1, f: 4 / 32 }, { dx: 2, dy: 1, f: 2 / 32 }\r\n    ],\r\n    'stucki': [\r\n        { dx: 1, dy: 0, f: 8 / 42 }, { dx: 2, dy: 0, f: 4 / 42 }, { dx: -2, dy: 1, f: 2 / 42 }, { dx: -1, dy: 1, f: 4 / 42 },\r\n        { dx: 0, dy: 1, f: 8 / 42 }, { dx: 1, dy: 1, f: 4 / 42 }, { dx: 2, dy: 1, f: 2 / 42 }, { dx: -2, dy: 2, f: 1 / 42 },\r\n        { dx: -1, dy: 2, f: 2 / 42 }, { dx: 0, dy: 2, f: 4 / 42 }, { dx: 1, dy: 2, f: 2 / 42 }, { dx: 2, dy: 2, f: 1 / 42 }\r\n    ],\r\n    'sierra-2': [\r\n        { dx: 1, dy: 0, f: 4 / 16 }, { dx: 2, dy: 0, f: 3 / 16 }, { dx: -2, dy: 1, f: 1 / 16 }, { dx: -1, dy: 1, f: 2 / 16 },\r\n        { dx: 0, dy: 1, f: 3 / 16 }, { dx: 1, dy: 1, f: 2 / 16 }, { dx: 2, dy: 1, f: 1 / 16 }\r\n    ],\r\n    'sierra-lite': [\r\n        { dx: 1, dy: 0, f: 2 / 4 }, { dx: -1, dy: 1, f: 1 / 4 }, { dx: 0, dy: 1, f: 1 / 4 }\r\n    ],\r\n    'atkinson': [\r\n        { dx: 1, dy: 0, f: 1 / 8 }, { dx: 2, dy: 0, f: 1 / 8 }, { dx: -1, dy: 1, f: 1 / 8 },\r\n        { dx: 0, dy: 1, f: 1 / 8 }, { dx: 1, dy: 1, f: 1 / 8 }, { dx: 0, dy: 2, f: 1 / 8 }\r\n    ]\r\n};\r\n\r\ninterface FindClosestResult { color: RGB; dist: number; }\r\n\r\nfunction findClosestColor(\r\n  pixel: RGB,\r\n  palette: RGB[],\r\n  paletteLab: LAB[],\r\n  paletteOklab: OKLabColor[] | null,\r\n  algorithm: ColorMatchAlgorithm,\r\n  preserveDetailThreshold: number,\r\n  cache?: Map<number, FindClosestResult>,\r\n): FindClosestResult {\r\n    // Round to integers for cache key (handles float RGB from error diffusion)\r\n    const ri = Math.max(0, Math.min(255, Math.round(pixel.r)));\r\n    const gi = Math.max(0, Math.min(255, Math.round(pixel.g)));\r\n    const bi = Math.max(0, Math.min(255, Math.round(pixel.b)));\r\n    const cacheKey = (ri << 16) | (gi << 8) | bi;\r\n\r\n    if (cache) {\r\n      const cached = cache.get(cacheKey);\r\n      if (cached) {\r\n        // For preserve detail, cached result already accounts for it\r\n        return cached;\r\n      }\r\n    }\r\n\r\n    let minDist = Infinity;\r\n    let closest = palette[0];\r\n\r\n    // Use the integer-rounded pixel for matching (avoids sub-pixel noise)\r\n    const matchPixel = { r: ri, g: gi, b: bi };\r\n\r\n    if (algorithm === 'oklab') {\r\n      const pixelOk = rgbToOklab(matchPixel);\r\n      for (let i = 0; i < palette.length; i++) {\r\n        const dist = deltaE_OKLab(pixelOk, paletteOklab![i]);\r\n        if (dist < minDist) { minDist = dist; closest = palette[i]; }\r\n      }\r\n    } else if (algorithm === 'redmean') {\r\n      for (let i = 0; i < palette.length; i++) {\r\n        const dist = deltaE_Redmean(matchPixel, palette[i]);\r\n        if (dist < minDist) { minDist = dist; closest = palette[i]; }\r\n      }\r\n    } else {\r\n      const pixelLab = rgbToLab(matchPixel);\r\n      const distFn = algorithm === 'ciede2000' ? deltaE_CIEDE2000\r\n                   : algorithm === 'cie94'     ? deltaE_CIE94\r\n                   :                             deltaE_CIE76;\r\n      for (let i = 0; i < palette.length; i++) {\r\n        const dist = distFn(pixelLab, paletteLab[i]);\r\n        if (dist < minDist) { minDist = dist; closest = palette[i]; }\r\n      }\r\n    }\r\n\r\n    let result: FindClosestResult;\r\n\r\n    // Preserve detail: if the closest color is within the threshold, keep original pixel\r\n    if (preserveDetailThreshold > 0 && minDist <= preserveDetailThreshold) {\r\n      result = { color: matchPixel, dist: 0 };\r\n    } else {\r\n      result = { color: closest, dist: minDist };\r\n    }\r\n\r\n    if (cache) {\r\n      cache.set(cacheKey, result);\r\n    }\r\n\r\n    return result;\r\n}\r\n\r\nfunction applyDithering(\r\n  imageData: ImageData,\r\n  paletteHex: string[],\r\n  algorithm: string,\r\n  strength: number,\r\n  colorMatchAlgorithm: ColorMatchAlgorithm = 'oklab',\r\n  preserveDetailThreshold: number = 0,\r\n) {\r\n    const pixels = imageData.data;\r\n    const width = imageData.width;\r\n    const height = imageData.height;\r\n    \r\n    const paletteRGB = paletteHex.map(hexToRgb);\r\n    const paletteLab = paletteRGB.map(rgbToLab);\r\n    const paletteOklab = colorMatchAlgorithm === 'oklab' ? paletteRGB.map(rgbToOklab) : null;\r\n\r\n    // Color cache: avoids recomputing expensive distance functions for identical RGB values\r\n    const colorCache = new Map<number, FindClosestResult>();\r\n\r\n    const strengthFactor = strength / 100;\r\n\r\n    if (algorithm in ditherMatrices) {\r\n        // Ordered Dithering\r\n        const dither = ditherMatrices[algorithm];\r\n        const matrix = dither.matrix;\r\n        const mSize = dither.size;\r\n        const mDiv = dither.divisor;\r\n        const BASE_DITHER_STRENGTH = 64; // Increased base strength\r\n\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                const index = (y * width + x) * 4;\r\n                if (pixels[index + 3] < 128) { pixels[index + 3] = 0; continue; }\r\n\r\n                const mX = x % mSize;\r\n                const mY = y % mSize;\r\n                const threshold = matrix[mY][mX];\r\n                \r\n                // Nudge calculation\r\n                const nudge = (threshold / mDiv - 0.5) * BASE_DITHER_STRENGTH * strengthFactor;\r\n\r\n                const oldColor = {\r\n                    r: Math.max(0, Math.min(255, pixels[index] + nudge)),\r\n                    g: Math.max(0, Math.min(255, pixels[index + 1] + nudge)),\r\n                    b: Math.max(0, Math.min(255, pixels[index + 2] + nudge))\r\n                };\r\n\r\n                const { color: newColor } = findClosestColor(oldColor, paletteRGB, paletteLab, paletteOklab, colorMatchAlgorithm, preserveDetailThreshold, colorCache);\r\n\r\n                pixels[index] = newColor.r;\r\n                pixels[index + 1] = newColor.g;\r\n                pixels[index + 2] = newColor.b;\r\n                pixels[index + 3] = 255;\r\n            }\r\n        }\r\n    } else {\r\n        // Error Diffusion\r\n        const pixelDataFloat = new Float32Array(pixels);\r\n        const kernel = errorKernels[algorithm];\r\n\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                const index = (y * width + x) * 4;\r\n                if (pixelDataFloat[index + 3] < 128) { pixels[index + 3] = 0; continue; }\r\n\r\n                const oldColor = { \r\n                    r: pixelDataFloat[index], \r\n                    g: pixelDataFloat[index + 1], \r\n                    b: pixelDataFloat[index + 2] \r\n                };\r\n                \r\n                const { color: newColor } = findClosestColor(oldColor, paletteRGB, paletteLab, paletteOklab, colorMatchAlgorithm, preserveDetailThreshold, colorCache);\r\n\r\n                pixels[index] = newColor.r;\r\n                pixels[index + 1] = newColor.g;\r\n                pixels[index + 2] = newColor.b;\r\n                pixels[index + 3] = 255;\r\n\r\n                if (algorithm === 'none' || !kernel) continue;\r\n\r\n                const err = { \r\n                    r: (oldColor.r - newColor.r) * strengthFactor, \r\n                    g: (oldColor.g - newColor.g) * strengthFactor, \r\n                    b: (oldColor.b - newColor.b) * strengthFactor \r\n                };\r\n\r\n                for (const k of kernel) {\r\n                    const nX = x + k.dx, nY = y + k.dy;\r\n                    if (nX >= 0 && nX < width && nY >= 0 && nY < height) {\r\n                        const i2 = (nY * width + nX) * 4;\r\n                        if (pixelDataFloat[i2 + 3] < 128) continue;\r\n                        pixelDataFloat[i2] += err.r * k.f;\r\n                        pixelDataFloat[i2 + 1] += err.g * k.f;\r\n                        pixelDataFloat[i2 + 2] += err.b * k.f;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// --- K-Means Clustering ---\r\n\r\nfunction kmeans(data: number[][], k: number, maxIterations = 20): Promise<{ centroids: number[][], assignments: number[] }> {\r\n    return new Promise(resolve => {\r\n        if (k > data.length) {\r\n            k = data.length;\r\n        }\r\n        if (k === 0) {\r\n            resolve({ centroids: [], assignments: [] });\r\n            return;\r\n        }\r\n\r\n        let centroids: number[][] = [];\r\n        const tempData = [...data];\r\n        for (let i = 0; i < k; i++) {\r\n            const index = Math.floor(Math.random() * tempData.length);\r\n            centroids.push(tempData.splice(index, 1)[0]);\r\n        }\r\n\r\n        let assignments = new Array(data.length);\r\n\r\n        for (let iter = 0; iter < maxIterations; iter++) {\r\n            for (let i = 0; i < data.length; i++) {\r\n                let min_dist = Infinity;\r\n                let best_centroid = -1;\r\n                for (let j = 0; j < k; j++) {\r\n                    const dist = (data[i][0] - centroids[j][0]) ** 2 + (data[i][1] - centroids[j][1]) ** 2 + (data[i][2] - centroids[j][2]) ** 2;\r\n                    if (dist < min_dist) { min_dist = dist; best_centroid = j; }\r\n                }\r\n                assignments[i] = best_centroid;\r\n            }\r\n\r\n            const newCentroids = Array.from({ length: k }, () => [0, 0, 0]);\r\n            const counts = new Array(k).fill(0);\r\n            for (let i = 0; i < data.length; i++) {\r\n                const cIndex = assignments[i];\r\n                newCentroids[cIndex][0] += data[i][0];\r\n                newCentroids[cIndex][1] += data[i][1];\r\n                newCentroids[cIndex][2] += data[i][2];\r\n                counts[cIndex]++;\r\n            }\r\n\r\n            for (let i = 0; i < k; i++) {\r\n                if (counts[i] > 0) {\r\n                    newCentroids[i][0] /= counts[i];\r\n                    newCentroids[i][1] /= counts[i];\r\n                    newCentroids[i][2] /= counts[i];\r\n                } else {\r\n                    newCentroids[i] = data[Math.floor(Math.random() * data.length)];\r\n                }\r\n            }\r\n\r\n            let changed = false;\r\n            for (let i = 0; i < k; i++) {\r\n                if (centroids[i][0] !== newCentroids[i][0] || centroids[i][1] !== newCentroids[i][1] || centroids[i][2] !== newCentroids[i][2]) {\r\n                    changed = true; break;\r\n                }\r\n            }\r\n            centroids = newCentroids;\r\n            if (!changed) break;\r\n        }\r\n\r\n        resolve({ centroids, assignments });\r\n    });\r\n}\r\n\r\nfunction rgbToHex(rgb: { r: number; g: number; b: number }): string {\r\n    const toHex = (c: number) => {\r\n        const hex = Math.round(c).toString(16);\r\n        return hex.length === 1 ? '0' + hex : hex;\r\n    };\r\n    return `#${toHex(rgb.r)}${toHex(rgb.g)}${toHex(rgb.b)}`.toUpperCase();\r\n}\r\n\r\nasync function suggestMissingColors(\r\n    imageData: ImageData, \r\n    paletteHex: string[], \r\n    numToSuggest: number,\r\n    preferDistinct: boolean = false\r\n): Promise<string[]> {\r\n    if (paletteHex.length === 0) return [];\r\n    \r\n    const paletteRGB = paletteHex.map(hexToRgb);\r\n    const paletteLAB = paletteRGB.map(rgbToLab);\r\n    \r\n    // Extract non-transparent pixels with sampling for performance\r\n    const pixels = imageData.data;\r\n    const pixelArray: number[][] = [];\r\n    \r\n    // Calculate step size to limit total pixels to approx 4096 (64x64) for performance\r\n    const totalPixels = pixels.length / 4;\r\n    const maxPixels = 4096;\r\n    const step = Math.ceil(totalPixels / maxPixels) * 4;\r\n\r\n    for (let i = 0; i < pixels.length; i += step) {\r\n        if (pixels[i + 3] > 128) {\r\n            pixelArray.push([pixels[i], pixels[i + 1], pixels[i + 2]]);\r\n        }\r\n    }\r\n    \r\n    if (pixelArray.length === 0) return [];\r\n    \r\n    // Run K-Means to find dominant clusters\r\n    // If preferDistinct is true, use double the clusters for better diversity\r\n    let k = Math.min(128, pixelArray.length);\r\n    if (preferDistinct) {\r\n        k = Math.min(256, pixelArray.length);\r\n    }\r\n    \r\n    const kmeansResult = await kmeans(pixelArray, k);\r\n    const centroids = kmeansResult.centroids;\r\n    const assignments = kmeansResult.assignments;\r\n    \r\n    // Count pixels per cluster\r\n    const pixelCounts = new Array(centroids.length).fill(0);\r\n    for (const assignment of assignments) {\r\n        pixelCounts[assignment]++;\r\n    }\r\n    \r\n    // Calculate error for each centroid\r\n    const centroidErrors: { hex: string; rgb: RGB; error: number; count: number; totalError: number }[] = [];\r\n    \r\n    for (let i = 0; i < centroids.length; i++) {\r\n        const c = centroids[i];\r\n        const count = pixelCounts[i];\r\n        \r\n        if (count === 0) continue;\r\n        \r\n        const centroidColorRGB = { r: Math.round(c[0]), g: Math.round(c[1]), b: Math.round(c[2]) };\r\n        const centroidColorLAB = rgbToLab(centroidColorRGB);\r\n        \r\n        // Find closest color in palette using CIELAB\r\n        let minDeltaE = Infinity;\r\n        for (const colorLAB of paletteLAB) {\r\n            const dist = getDeltaE(centroidColorLAB, colorLAB);\r\n            if (dist < minDeltaE) {\r\n                minDeltaE = dist;\r\n            }\r\n        }\r\n        \r\n        const totalError = minDeltaE * count;\r\n        \r\n        centroidErrors.push({\r\n            hex: rgbToHex(centroidColorRGB),\r\n            rgb: centroidColorRGB,\r\n            error: minDeltaE,\r\n            count: count,\r\n            totalError: totalError\r\n        });\r\n    }\r\n    \r\n    // Sort by total error (descending)\r\n    centroidErrors.sort((a, b) => b.totalError - a.totalError);\r\n    \r\n    // If not preferring distinct, just return top N\r\n    if (!preferDistinct) {\r\n        return centroidErrors.slice(0, numToSuggest).map(c => c.hex);\r\n    }\r\n    \r\n    // Greedy selection for distinct colors\r\n    // Start with highest error, then greedily add colors that are:\r\n    // 1. High error (good candidates)\r\n    // 2. Sufficiently distinct from already-selected colors (ΔE > 30)\r\n    const selected: typeof centroidErrors = [];\r\n    const minDistinctness = 30; // CIELAB distance threshold\r\n    \r\n    for (const candidate of centroidErrors) {\r\n        if (selected.length >= numToSuggest) break;\r\n        \r\n        if (selected.length === 0) {\r\n            // Always take the highest error color first\r\n            selected.push(candidate);\r\n        } else {\r\n            // Check if this color is distinct from all selected colors\r\n            let isDistinct = true;\r\n            const candidateLAB = rgbToLab(candidate.rgb);\r\n            \r\n            for (const sel of selected) {\r\n                const selLAB = rgbToLab(sel.rgb);\r\n                const deltaE = getDeltaE(candidateLAB, selLAB);\r\n                if (deltaE < minDistinctness) {\r\n                    isDistinct = false;\r\n                    break;\r\n                }\r\n            }\r\n            \r\n            if (isDistinct) {\r\n                selected.push(candidate);\r\n            }\r\n        }\r\n    }\r\n    \r\n    return selected.map(c => c.hex);\r\n}\r\n\r\nfunction applyColorModifiers(imageData: ImageData, brightness: number, contrast: number, saturation: number): ImageData {\r\n  // ... [Keep existing implementation] ...\r\n  const data = imageData.data;\r\n  const width = imageData.width;\r\n  const height = imageData.height;\r\n  const newImageData = new ImageData(new Uint8ClampedArray(data), width, height);\r\n  const d = newImageData.data;\r\n\r\n  const contrastFactor = (259 * (contrast + 255)) / (255 * (259 - contrast));\r\n\r\n  for (let i = 0; i < d.length; i += 4) {\r\n    let r = d[i];\r\n    let g = d[i+1];\r\n    let b = d[i+2];\r\n\r\n    // Brightness\r\n    r += brightness;\r\n    g += brightness;\r\n    b += brightness;\r\n\r\n    // Contrast\r\n    r = contrastFactor * (r - 128) + 128;\r\n    g = contrastFactor * (g - 128) + 128;\r\n    b = contrastFactor * (b - 128) + 128;\r\n\r\n    // Saturation\r\n    if (saturation !== 0) {\r\n        const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;\r\n        const satMult = 1 + (saturation / 100);\r\n        r = gray + (r - gray) * satMult;\r\n        g = gray + (g - gray) * satMult;\r\n        b = gray + (b - gray) * satMult;\r\n    }\r\n\r\n    d[i] = Math.max(0, Math.min(255, r));\r\n    d[i+1] = Math.max(0, Math.min(255, g));\r\n    d[i+2] = Math.max(0, Math.min(255, b));\r\n  }\r\n\r\n  return newImageData;\r\n}\r\n\r\n// --- Preprocessing Filters ---\r\n\r\n// 1. Median Filter: excellent for removing noise/dithering while keeping edges sharp\r\nfunction applyMedianFilter(imageData: ImageData, strength: number): ImageData {\r\n  const src = imageData.data;\r\n  const width = imageData.width;\r\n  const height = imageData.height;\r\n  const dest = new ImageData(new Uint8ClampedArray(src), width, height);\r\n  const destData = dest.data;\r\n\r\n  // Map strength 0-100 to radius 1-10\r\n  const radius = Math.max(1, Math.floor((strength / 100) * 10)); \r\n  \r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const idx = (y * width + x) * 4;\r\n      \r\n      const rValues = [];\r\n      const gValues = [];\r\n      const bValues = [];\r\n\r\n      for (let ky = -radius; ky <= radius; ky++) {\r\n        for (let kx = -radius; kx <= radius; kx++) {\r\n          const py = Math.min(height - 1, Math.max(0, y + ky));\r\n          const px = Math.min(width - 1, Math.max(0, x + kx));\r\n          const pIdx = (py * width + px) * 4;\r\n          \r\n          rValues.push(src[pIdx]);\r\n          gValues.push(src[pIdx+1]);\r\n          bValues.push(src[pIdx+2]);\r\n        }\r\n      }\r\n\r\n      rValues.sort((a, b) => a - b);\r\n      gValues.sort((a, b) => a - b);\r\n      bValues.sort((a, b) => a - b);\r\n\r\n      const mid = Math.floor(rValues.length / 2);\r\n\r\n      destData[idx] = rValues[mid];\r\n      destData[idx + 1] = gValues[mid];\r\n      destData[idx + 2] = bValues[mid];\r\n      destData[idx + 3] = src[idx + 3];\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\n// 2. Bilateral Filter: Blurs similar colors\r\nfunction applyBilateralFilter(imageData: ImageData, strength: number): ImageData {\r\n  const src = imageData.data;\r\n  const width = imageData.width;\r\n  const height = imageData.height;\r\n  const dest = new ImageData(new Uint8ClampedArray(src), width, height);\r\n  const destData = dest.data;\r\n  \r\n  // Revised mapping: \r\n  // Strength 0-100 -> Radius 2-12 (larger radius needed for HD images)\r\n  const spatialRadius = Math.max(2, Math.floor((strength / 100) * 12)); \r\n  const sigmaSpatial = spatialRadius / 2;\r\n  const sigmaColor = 30 + (strength * 1.5); // Color tolerance\r\n  \r\n  // Precompute spatial weights\r\n  const spatialWeights = [];\r\n  for (let i = -spatialRadius; i <= spatialRadius; i++) {\r\n      spatialWeights.push(Math.exp(-(i * i) / (2 * sigmaSpatial * sigmaSpatial)));\r\n  }\r\n  \r\n  // Lookup table for color weights (speed optimization)\r\n  const colorWeights = new Float32Array(256 * 3); // Approx max diff\r\n  const colorCoeff = -1 / (2 * sigmaColor * sigmaColor);\r\n  for (let i = 0; i < colorWeights.length; i++) {\r\n      colorWeights[i] = Math.exp(i * i * colorCoeff);\r\n  }\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const idx = (y * width + x) * 4;\r\n      const centerR = src[idx];\r\n      const centerG = src[idx + 1];\r\n      const centerB = src[idx + 2];\r\n      \r\n      let sumR = 0, sumG = 0, sumB = 0, sumW = 0;\r\n      \r\n      for (let dy = -spatialRadius; dy <= spatialRadius; dy++) {\r\n        const ny = y + dy;\r\n        if (ny < 0 || ny >= height) continue;\r\n        const spatialW_Y = spatialWeights[dy + spatialRadius];\r\n\r\n        for (let dx = -spatialRadius; dx <= spatialRadius; dx++) {\r\n          const nx = x + dx;\r\n          if (nx < 0 || nx >= width) continue;\r\n          \r\n          const nIdx = (ny * width + nx) * 4;\r\n          const nR = src[nIdx];\r\n          const nG = src[nIdx + 1];\r\n          const nB = src[nIdx + 2];\r\n          \r\n          const dist = Math.abs(nR - centerR) + Math.abs(nG - centerG) + Math.abs(nB - centerB);\r\n          const weight = spatialW_Y * spatialWeights[dx + spatialRadius] * Math.exp(dist * dist * colorCoeff); // simple approximation\r\n\r\n          sumR += nR * weight;\r\n          sumG += nG * weight;\r\n          sumB += nB * weight;\r\n          sumW += weight;\r\n        }\r\n      }\r\n      \r\n      destData[idx] = sumR / sumW;\r\n      destData[idx + 1] = sumG / sumW;\r\n      destData[idx + 2] = sumB / sumW;\r\n      destData[idx + 3] = src[idx + 3];\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\n// 3. Kuwahara Filter: The \"Oil Paint\" effect, critical for pixel art clustering\r\nfunction applyKuwaharaFilter(imageData: ImageData, strength: number): ImageData {\r\n  const src = imageData.data;\r\n  const width = imageData.width;\r\n  const height = imageData.height;\r\n  const dest = new ImageData(new Uint8ClampedArray(src), width, height);\r\n  const destData = dest.data;\r\n  \r\n  // Revised mapping: Radius 2 to 14. \r\n  // Small radii (2-4) are barely visible on large images. \r\n  // Large radii (10+) create the distinct \"flat\" look.\r\n  const radius = Math.max(2, Math.floor((strength / 100) * 14));\r\n  \r\n  // Pre-calculate integral images could optimize this, but for now we stick to direct logic for clarity\r\n  \r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const idx = (y * width + x) * 4;\r\n      if (src[idx+3] === 0) continue;\r\n\r\n      let minVariance = Infinity;\r\n      let bestMean = { r: src[idx], g: src[idx+1], b: src[idx+2] };\r\n      \r\n      // The 4 sub-quadrants\r\n      const ranges = [\r\n          [ -radius, 0, -radius, 0 ], // TL\r\n          [ 0, radius, -radius, 0 ],  // TR\r\n          [ -radius, 0, 0, radius ],  // BL\r\n          [ 0, radius, 0, radius ]    // BR\r\n      ];\r\n\r\n      for (let i = 0; i < 4; i++) {\r\n          const [xStart, xEnd, yStart, yEnd] = ranges[i];\r\n          let rSum = 0, gSum = 0, bSum = 0;\r\n          let rSqSum = 0, gSqSum = 0, bSqSum = 0;\r\n          let count = 0;\r\n\r\n          for (let dy = yStart; dy <= yEnd; dy++) {\r\n              const ny = y + dy;\r\n              if (ny < 0 || ny >= height) continue;\r\n              \r\n              for (let dx = xStart; dx <= xEnd; dx++) {\r\n                  const nx = x + dx;\r\n                  if (nx < 0 || nx >= width) continue;\r\n\r\n                  const pIdx = (ny * width + nx) * 4;\r\n                  const r = src[pIdx];\r\n                  const g = src[pIdx+1];\r\n                  const b = src[pIdx+2];\r\n\r\n                  rSum += r; gSum += g; bSum += b;\r\n                  rSqSum += r*r; gSqSum += g*g; bSqSum += b*b;\r\n                  count++;\r\n              }\r\n          }\r\n\r\n          if (count === 0) continue;\r\n\r\n          const meanR = rSum / count;\r\n          const meanG = gSum / count;\r\n          const meanB = bSum / count;\r\n          \r\n          const variance = (rSqSum + gSqSum + bSqSum) / count - (meanR*meanR + meanG*meanG + meanB*meanB);\r\n\r\n          if (variance < minVariance) {\r\n              minVariance = variance;\r\n              bestMean = { r: meanR, g: meanG, b: meanB };\r\n          }\r\n      }\r\n\r\n      destData[idx] = bestMean.r;\r\n      destData[idx + 1] = bestMean.g;\r\n      destData[idx + 2] = bestMean.b;\r\n      destData[idx + 3] = src[idx + 3];\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\n// --- Main Handler ---\r\n\r\nself.onmessage = async (e: MessageEvent) => {\r\n    // ... [Keep Suggestion handling logic] ...\r\n    const { type, imageData, settings } = e.data;\r\n    \r\n    if (type === 'suggest') {\r\n        try {\r\n            const { palette, numSuggestions, preferDistinct } = settings;\r\n            const suggestions = await suggestMissingColors(imageData, palette, numSuggestions || 5, preferDistinct || false);\r\n            self.postMessage({ type: 'suggestions', suggestions });\r\n        } catch (error: any) {\r\n            self.postMessage({ type: 'error', message: error.message });\r\n        }\r\n        return;\r\n    }\r\n\r\n    const { targetWidth, targetHeight, ditherMethod, ditherStrength, palette, resamplingMethod, useKmeans, kmeansColors, brightness, contrast, saturation, preprocessingMethod, preprocessingStrength, filterTrivialColors, trivialThreshold, colorStats, colorMatchAlgorithm: rawAlgo, preserveDetailThreshold: rawPDT } = settings;\r\n    const colorMatchAlgorithm: ColorMatchAlgorithm = rawAlgo || 'oklab';\r\n    const preserveDetailThreshold: number = rawPDT || 0;\r\n\r\n    try {\r\n        // Filter out trivial colors if enabled\r\n        let effectivePalette = palette;\r\n        if (filterTrivialColors && colorStats && Array.isArray(colorStats) && colorStats.length > 0) {\r\n            const threshold = typeof trivialThreshold === 'number' && trivialThreshold > 0 ? trivialThreshold : 0.1;\r\n            const colorStatsMap = new Map((colorStats as Array<{ color: string; percent: number }>).map((item: { color: string; percent: number }) => [item.color, item.percent]));\r\n            effectivePalette = palette.filter((color: string) => {\r\n                const percent = colorStatsMap.get(color);\r\n                // Keep color if it's not in stats (unused) or if it's above threshold\r\n                // For filtering, we want to EXCLUDE unused and below-threshold colors\r\n                if (!percent) return false; // Exclude unused\r\n                return percent >= threshold; // Only keep above dynamic threshold\r\n            });\r\n            // If all colors would be filtered, keep the original palette\r\n            if (effectivePalette.length === 0) {\r\n                effectivePalette = palette;\r\n            }\r\n        }\r\n\r\n        // 0. Apply Color Modifiers (Global Adjustments)\r\n        let processedImageData = imageData;\r\n        if ((brightness && brightness !== 0) || (contrast && contrast !== 0) || (saturation && saturation !== 0)) {\r\n            processedImageData = applyColorModifiers(imageData, brightness || 0, contrast || 0, saturation || 0);\r\n        }\r\n\r\n        // 0.5. Apply Preprocessing Filters\r\n        // Filters now use improved \"Radius\" mapping based on strength\r\n        if (preprocessingMethod && preprocessingMethod !== 'none') {\r\n            const strength = preprocessingStrength || 50;\r\n            \r\n            if (preprocessingMethod === 'median') {\r\n                processedImageData = applyMedianFilter(processedImageData, strength);\r\n            } else if (preprocessingMethod === 'bilateral') {\r\n                processedImageData = applyBilateralFilter(processedImageData, strength);\r\n            } else if (preprocessingMethod === 'kuwahara') {\r\n                processedImageData = applyKuwaharaFilter(processedImageData, strength);\r\n            }\r\n        }\r\n\r\n        // ... [Rest of logic: Resize -> Kmeans -> Dither remains exactly the same] ...\r\n        // 1. Resize\r\n        let resizedImageData: ImageData;\r\n        if (resamplingMethod === 'lanczos') {\r\n            resizedImageData = resampleLanczos(processedImageData, targetWidth, targetHeight);\r\n        } else if (resamplingMethod === 'bilinear') {\r\n            resizedImageData = resampleBilinear(processedImageData, targetWidth, targetHeight);\r\n        } else {\r\n            resizedImageData = resampleNearest(processedImageData, targetWidth, targetHeight);\r\n        }\r\n\r\n        // 2. K-Means\r\n        let generatedPalette: string[] | undefined;\r\n        if (useKmeans && kmeansColors > 0) {\r\n           // ... [Existing Kmeans logic] ...\r\n           const pixels = resizedImageData.data;\r\n           const pixelArray: number[][] = [];\r\n           for (let i = 0; i < pixels.length; i += 4) {\r\n                if (pixels[i + 3] > 128) {\r\n                    pixelArray.push([pixels[i], pixels[i + 1], pixels[i + 2]]);\r\n                }\r\n           }\r\n\r\n            if (pixelArray.length > 0) {\r\n                const kmeansResult = await kmeans(pixelArray, Math.min(kmeansColors, pixelArray.length));\r\n                const paletteRGB = kmeansResult.centroids.map(c => ({\r\n                    r: Math.round(c[0]),\r\n                    g: Math.round(c[1]),\r\n                    b: Math.round(c[2])\r\n                }));\r\n                \r\n                generatedPalette = paletteRGB.map(c => \r\n                    \"#\" + ((1 << 24) + (c.r << 16) + (c.g << 8) + c.b).toString(16).slice(1).toUpperCase()\r\n                );\r\n\r\n                const paletteLab = paletteRGB.map(rgbToLab);\r\n                const paletteOk = colorMatchAlgorithm === 'oklab' ? paletteRGB.map(rgbToOklab) : null;\r\n                const kmeansCache = new Map<number, FindClosestResult>();\r\n\r\n                for (let i = 0; i < pixels.length; i += 4) {\r\n                    if (pixels[i + 3] > 128) {\r\n                        const pixelColor = { r: pixels[i], g: pixels[i + 1], b: pixels[i + 2] };\r\n                        const { color: closestColor } = findClosestColor(pixelColor, paletteRGB, paletteLab, paletteOk, colorMatchAlgorithm, 0, kmeansCache);\r\n                        pixels[i] = closestColor.r;\r\n                        pixels[i + 1] = closestColor.g;\r\n                        pixels[i + 2] = closestColor.b;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // 3. Dither\r\n        if (effectivePalette && effectivePalette.length > 0) {\r\n            applyDithering(resizedImageData, effectivePalette, ditherMethod, ditherStrength, colorMatchAlgorithm, preserveDetailThreshold);\r\n        }\r\n\r\n        self.postMessage({ type: 'success', imageData: resizedImageData, generatedPalette });\r\n\r\n    } catch (error: any) {\r\n        self.postMessage({ type: 'error', message: error.message });\r\n    }\r\n};\r\n"],"names":["hexToRgb","hex","result","rgbToXyz","c","r","g","b","xyzToLab","x","y","z","rgbToLab","rgbToOklab","l_","m_","s_","l3","m3","s3","deltaE_CIE76","labA","labB","dL","da","db","deltaE_Redmean","a","rMean","dr","dg","deltaE_CIE94","C1","C2","dC","dH2","dH","kL","K1","K2","SL","SC","SH","t1","t2","t3","deltaE_CIEDE2000","L1","a1","b1","L2","a2","b2","avgC","avgC7","G","a1p","a2p","C1p","C2p","avgCp","h1p","h2p","dLp","dCp","dhp","dHp","avgLp","avgHp","T","avgCp7","RT","tL","tC","tH","deltaE_OKLab","getDeltaE","resampleNearest","srcData","width","height","src","dest","destData","xRatio","yRatio","srcX","srcIdx","destIdx","resampleBilinear","srcY","srcW","srcH","totalWeight","startX","startY","endX","endY","sy","sx","weightX","weightY","weight","x1","y1","x2","y2","dx","dy","v1","v2","v3","v4","top","bottom","value","resampleLanczos","imageData","srcWidth","srcHeight","tempBuffer","sinc","piX","lanczosKernel","ratioX","scaleX","radiusX","a_val","i","destImageData","ratioY","scaleY","radiusY","ditherMatrices","errorKernels","findClosestColor","pixel","palette","paletteLab","paletteOklab","algorithm","preserveDetailThreshold","cache","ri","gi","bi","cacheKey","cached","minDist","closest","matchPixel","pixelOk","dist","pixelLab","distFn","applyDithering","paletteHex","strength","colorMatchAlgorithm","pixels","paletteRGB","colorCache","strengthFactor","dither","matrix","mSize","mDiv","BASE_DITHER_STRENGTH","index","mX","mY","nudge","oldColor","newColor","pixelDataFloat","kernel","err","k","nX","nY","i2","kmeans","data","maxIterations","resolve","centroids","tempData","assignments","iter","min_dist","best_centroid","j","newCentroids","counts","cIndex","changed","rgbToHex","rgb","toHex","suggestMissingColors","numToSuggest","preferDistinct","paletteLAB","pixelArray","totalPixels","step","kmeansResult","pixelCounts","assignment","centroidErrors","count","centroidColorRGB","centroidColorLAB","minDeltaE","colorLAB","totalError","selected","minDistinctness","candidate","isDistinct","candidateLAB","sel","selLAB","applyColorModifiers","brightness","contrast","saturation","newImageData","d","contrastFactor","gray","satMult","applyMedianFilter","radius","idx","rValues","gValues","bValues","ky","kx","py","px","pIdx","mid","applyBilateralFilter","spatialRadius","sigmaSpatial","sigmaColor","spatialWeights","colorWeights","colorCoeff","centerR","centerG","centerB","sumR","sumG","sumB","sumW","ny","spatialW_Y","nx","nIdx","nR","nG","nB","applyKuwaharaFilter","minVariance","bestMean","ranges","xStart","xEnd","yStart","yEnd","rSum","gSum","bSum","rSqSum","gSqSum","bSqSum","meanR","meanG","meanB","variance","e","type","settings","numSuggestions","suggestions","error","targetWidth","targetHeight","ditherMethod","ditherStrength","resamplingMethod","useKmeans","kmeansColors","preprocessingMethod","preprocessingStrength","filterTrivialColors","trivialThreshold","colorStats","rawAlgo","rawPDT","effectivePalette","threshold","colorStatsMap","item","color","percent","processedImageData","resizedImageData","generatedPalette","paletteOk","kmeansCache","pixelColor","closestColor"],"mappings":"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"}